{{
    config(
        tags=["ax_hist_fact","ax_hist_sales","ax_hist_on_demand"]
    )
}}


with
    source as (select * from {{ source("FACTS_FOR_COMPARE", "sls_wtx_promo_fact") }} where  {{env_var("DBT_PICK_FROM_CONV")}}='Y'),

    renamed as (

        select
            source_system,
            promo_idx,
            {{
                dbt_utils.surrogate_key(
                    ["source_system", "promo_idx"]
                )
            }} as promo_guid,
            cust_idx,
            plan_source_customer_code,
            customer_address_number_guid,
            sku_idx,
            source_item_identifier,
            {{ dbt_utils.surrogate_key(["source_system", "source_item_identifier"]) }}
            as item_guid,
            calendar_date,
            snapshot_date,
            reportingsku_idx,
            ispromosku,
            iscannibsku,
            issi_prepromoday,
            issi_onpromoday,
            issi_postpromoday,
            isso_prepromoday,
            isso_onpromoday,
            isso_postpromoday,
            si_b_vol_cse,
            si_b_vol_sgl,
            si_a_vol_cse,
            si_a_vol_sgl,
            si_t_vol_cse,
            si_t_vol_sgl,
            si_m_vol_cse,
            si_m_vol_sgl,
            si_i_vol_cse,
            si_i_vol_sgl,
            so_b_vol_cse,
            so_b_vol_sgl,
            so_a_vol_cse,
            so_a_vol_sgl,
            so_t_vol_cse,
            so_t_vol_sgl,
            so_m_vol_cse,
            so_m_vol_sgl,
            so_i_vol_cse,
            so_i_vol_sgl,
            si_cannib_vol_cse,
            si_cannib_vol_sgl,
            so_cannib_vol_cse,
            so_cannib_vol_sgl,
            si_cannib_basevol_cse,
            si_cannib_basevol_sgl,
            so_cannib_basevol_cse,
            so_cannib_basevol_sgl,
            si_cannib_loss_vol_cse,
            si_cannib_loss_vol_sgl,
            so_cannib_loss_vol_cse,
            so_cannib_loss_vol_sgl,
            si_predip_vol_cse,
            si_predip_vol_sgl,
            si_postdip_vol_cse,
            si_postdip_vol_sgl,
            so_predip_vol_cse,
            so_predip_vol_sgl,
            so_postdip_vol_cse,
            so_postdip_vol_sgl,
            si_predip_basevol_cse,
            si_predip_basevol_sgl,
            si_postdip_basevol_cse,
            si_postdip_basevol_sgl,
            so_predip_basevol_cse,
            so_predip_basevol_sgl,
            so_postdip_basevol_cse,
            so_postdip_basevol_sgl,
            postpromodippercent_si,
            postpromodippercent_so,
            prepromodippercent_si,
            prepromodippercent_so,
            onpromophasingpercent_si,
            onpromophasingpercent_so,
            robfundingrequired,
            actuals_tot_vol_kg,
            actuals_ap_gross_sales_value,
            actuals_ap_range_support_allowance,
            actuals_ap_everyday_low_prices,
            actuals_ap_permanent_disc,
            actuals_ap_off_invoice_disc,
            actuals_ap_invoiced_sales_value,
            actuals_ap_early_settlement_disc,
            actuals_ap_growth_incentives,
            actuals_ap_net_sales_value,
            actuals_ap_retro,
            actuals_ap_avp_disc,
            actuals_ap_variable_trade,
            actuals_ap_promo_fixed_funding,
            actuals_ap_range_support_incentives,
            actuals_ap_net_net_sales_value,
            actuals_ap_direct_shopper_marketing,
            actuals_ap_other_direct_payments,
            actuals_ap_indirect_shopper_marketing,
            actuals_ap_other_indirect_payments,
            actuals_ap_fixed_trade_cust_invoiced,
            actuals_ap_total_trade_cust_invoiced,
            actuals_ap_fixed_trade_non_cust_invoiced,
            actuals_ap_total_trade,
            actuals_ap_net_realisable_revenue,
            actuals_ap_tot_prime_cost_standard,
            actuals_ap_gross_margin_standard,
            actuals_ap_gcat_standard,
            actuals_manso_tot_vol_kg,
            actuals_manso_gross_sales_value,
            actuals_manso_range_support_allowance,
            actuals_manso_everyday_low_prices,
            actuals_manso_permanent_disc,
            actuals_manso_off_invoice_disc,
            actuals_manso_invoiced_sales_value,
            actuals_manso_early_settlement_disc,
            actuals_manso_growth_incentives,
            actuals_manso_net_sales_value,
            actuals_manso_retro,
            actuals_manso_avp_disc,
            actuals_manso_variable_trade,
            actuals_manso_promo_fixed_funding,
            actuals_manso_range_support_incentives,
            actuals_manso_net_net_sales_value,
            actuals_manso_direct_shopper_marketing,
            actuals_manso_other_direct_payments,
            actuals_manso_indirect_shopper_marketing,
            actuals_manso_other_indirect_payments,
            actuals_manso_fixed_trade_cust_invoiced,
            actuals_manso_total_trade_cust_invoiced,
            actuals_manso_fixed_trade_non_cust_invoiced,
            actuals_manso_total_trade,
            actuals_manso_net_realisable_revenue,
            actuals_manso_tot_prime_cost_standard,
            actuals_manso_gross_margin_standard,
            actuals_manso_gcat_standard,
            actuals_retail_tot_vol_kg,
            actuals_ap_retail_revenue_mrrsp,
            actuals_ap_retail_revenue_rsp,
            actuals_ap_retail_revenue_net,
            actuals_ap_retail_cost_of_sales,
            actuals_ap_retail_retailer_retro_funding,
            actuals_ap_retail_margin_excl_fixed_funding,
            actuals_ap_retail_promo_fixed_spend,
            actuals_ap_retail_total_spend,
            actuals_ap_retail_margin_incl_fixed_funding,
            actuals_ap_retail_revenue_net_excl_mrrsp,
            actuals_ap_retail_revenue_net_excl_rsp,
            base_tot_vol_kg,
            base_ap_gross_sales_value,
            base_ap_range_support_allowance,
            base_ap_everyday_low_prices,
            base_ap_permanent_disc,
            base_ap_off_invoice_disc,
            base_ap_invoiced_sales_value,
            base_ap_early_settlement_disc,
            base_ap_growth_incentives,
            base_ap_net_sales_value,
            base_ap_retro,
            base_ap_avp_disc,
            base_ap_variable_trade,
            base_ap_promo_fixed_funding,
            base_ap_range_support_incentives,
            base_ap_net_net_sales_value,
            base_ap_direct_shopper_marketing,
            base_ap_other_direct_payments,
            base_ap_indirect_shopper_marketing,
            base_ap_other_indirect_payments,
            base_ap_fixed_trade_cust_invoiced,
            base_ap_total_trade_cust_invoiced,
            base_ap_fixed_trade_non_cust_invoiced,
            base_ap_total_trade,
            base_ap_net_realisable_revenue,
            base_ap_tot_prime_cost_standard,
            base_ap_gross_margin_standard,
            base_ap_gcat_standard,
            base_manso_tot_vol_kg,
            base_manso_gross_sales_value,
            base_manso_range_support_allowance,
            base_manso_everyday_low_prices,
            base_manso_permanent_disc,
            base_manso_off_invoice_disc,
            base_manso_invoiced_sales_value,
            base_manso_early_settlement_disc,
            base_manso_growth_incentives,
            base_manso_net_sales_value,
            base_manso_retro,
            base_manso_avp_disc,
            base_manso_variable_trade,
            base_manso_promo_fixed_funding,
            base_manso_range_support_incentives,
            base_manso_net_net_sales_value,
            base_manso_direct_shopper_marketing,
            base_manso_other_direct_payments,
            base_manso_indirect_shopper_marketing,
            base_manso_other_indirect_payments,
            base_manso_fixed_trade_cust_invoiced,
            base_manso_total_trade_cust_invoiced,
            base_manso_fixed_trade_non_cust_invoiced,
            base_manso_total_trade,
            base_manso_net_realisable_revenue,
            base_manso_tot_prime_cost_standard,
            base_manso_gross_margin_standard,
            base_manso_gcat_standard,
            base_retail_tot_vol_kg,
            base_ap_retail_revenue_mrrsp,
            base_ap_retail_revenue_rsp,
            base_ap_retail_revenue_net,
            base_ap_retail_cost_of_sales,
            base_ap_retail_retailer_retro_funding,
            base_ap_retail_margin_excl_fixed_funding,
            base_ap_retail_promo_fixed_spend,
            base_ap_retail_total_spend,
            base_ap_retail_margin_incl_fixed_funding,
            base_ap_retail_revenue_net_excl_mrrsp,
            base_ap_retail_revenue_net_excl_rsp,
            forecast_tot_vol_kg,
            forecast_ap_gross_sales_value,
            forecast_ap_range_support_allowance,
            forecast_ap_everyday_low_prices,
            forecast_ap_permanent_disc,
            forecast_ap_off_invoice_disc,
            forecast_ap_invoiced_sales_value,
            forecast_ap_early_settlement_disc,
            forecast_ap_growth_incentives,
            forecast_ap_net_sales_value,
            forecast_ap_retro,
            forecast_ap_avp_disc,
            forecast_ap_variable_trade,
            forecast_ap_promo_fixed_funding,
            forecast_ap_range_support_incentives,
            forecast_ap_net_net_sales_value,
            forecast_ap_direct_shopper_marketing,
            forecast_ap_other_direct_payments,
            forecast_ap_indirect_shopper_marketing,
            forecast_ap_other_indirect_payments,
            forecast_ap_fixed_trade_cust_invoiced,
            forecast_ap_total_trade_cust_invoiced,
            forecast_ap_fixed_trade_non_cust_invoiced,
            forecast_ap_total_trade,
            forecast_ap_total_trade_gbp,
            forecast_ap_net_realisable_revenue,
            forecast_ap_tot_prime_cost_standard,
            forecast_ap_gross_margin_standard,
            forecast_ap_gcat_standard,
            forecast_manso_tot_vol_kg,
            forecast_manso_gross_sales_value,
            forecast_manso_range_support_allowance,
            forecast_manso_everyday_low_prices,
            forecast_manso_permanent_disc,
            forecast_manso_off_invoice_disc,
            forecast_manso_invoiced_sales_value,
            forecast_manso_early_settlement_disc,
            forecast_manso_growth_incentives,
            forecast_manso_net_sales_value,
            forecast_manso_retro,
            forecast_manso_avp_disc,
            forecast_manso_variable_trade,
            forecast_manso_promo_fixed_funding,
            forecast_manso_range_support_incentives,
            forecast_manso_net_net_sales_value,
            forecast_manso_direct_shopper_marketing,
            forecast_manso_other_direct_payments,
            forecast_manso_indirect_shopper_marketing,
            forecast_manso_other_indirect_payments,
            forecast_manso_fixed_trade_cust_invoiced,
            forecast_manso_total_trade_cust_invoiced,
            forecast_manso_fixed_trade_non_cust_invoiced,
            forecast_manso_total_trade,
            forecast_manso_net_realisable_revenue,
            forecast_manso_tot_prime_cost_standard,
            forecast_manso_gross_margin_standard,
            forecast_manso_gcat_standard,
            forecast_retail_tot_vol_kg,
            forecast_ap_retail_revenue_mrrsp,
            forecast_ap_retail_revenue_rsp,
            forecast_ap_retail_revenue_net,
            forecast_ap_retail_cost_of_sales,
            forecast_ap_retail_retailer_retro_funding,
            forecast_ap_retail_margin_excl_fixed_funding,
            forecast_ap_retail_promo_fixed_spend,
            forecast_ap_retail_total_spend,
            forecast_ap_retail_margin_incl_fixed_funding,
            forecast_ap_retail_revenue_net_excl_mrrsp,
            forecast_ap_retail_revenue_net_excl_rsp,
            si_b_vol_kg,
            si_a_vol_kg,
            si_t_vol_kg,
            si_m_vol_kg,
            si_i_vol_kg,
            so_b_vol_kg,
            so_a_vol_kg,
            so_t_vol_kg,
            so_m_vol_kg,
            so_i_vol_kg,
            si_cannib_vol_kg,
            so_cannib_vol_kg,
            si_cannib_basevol_kg,
            so_cannib_basevol_kg,
            si_cannib_loss_vol_kg,
            so_cannib_loss_vol_kg,
            si_predip_vol_kg,
            si_postdip_vol_kg,
            so_predip_vol_kg,
            so_postdip_vol_kg,
            si_predip_basevol_kg,
            si_postdip_basevol_kg,
            so_predip_basevol_kg,
            so_postdip_basevol_kg,
            actuals_tot_vol_ca,
            actuals_tot_vol_ul,
            base_tot_vol_ca,
            base_tot_vol_ul,
            forecast_tot_vol_ca,
            forecast_tot_vol_ul,
            v_ca_kg_conv,
            prm_rpt_customer_code,
            {{
                dbt_utils.surrogate_key(
                    [
                        "source_system",
                        "prm_rpt_customer_code",
                        "'CUSTOMER_MAIN'",
                    ]
                )
            }} as prm_rpt_customer_guid,
            promo_code,
            {{
                dbt_utils.surrogate_key(
                    [
                        "source_system",
                        "promo_idx",
                        "plan_source_customer_code",
                        "source_item_identifier",
                        "calendar_date",
                        "snapshot_date",
                        "prm_rpt_customer_code",
                    ]
                )
            }} as unique_key

        from source

    )

select *
from renamed
