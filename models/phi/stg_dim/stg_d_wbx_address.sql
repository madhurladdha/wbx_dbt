{{
    config( materialized=env_var("DBT_MAT_TABLE"),
            transient=true)
}}

with company as (
select distinct
    NULL AS ACTIVE_INDICATOR,
    source_system_address_number as company_code,
    GENERIC_ADDRESS_TYPE,
    COMPANY_ADDRESS_GUID as ADDRESS_GUID,
    NULL AS ADDRESS_LINE_1,
    NULL AS ADDRESS_LINE_2,
    NULL AS ADDRESS_LINE_3,
    NULL AS ADDRESS_LINE_4,
    TYPE AS ADDRESS_TYPE,
    NULL AS ADDRESS_TYPE_DESCRIPTION,
    NULL AS BUSINESS_UNIT,
    NULL AS CITY,
    NULL AS CONTACT_1_DEPARTMENT_NAME,
    NULL AS CONTACT_1_EMAIL,
    NULL AS CONTACT_1_FIRST_NAME,
    NULL AS CONTACT_1_LAST_NAME,
    NULL AS CONTACT_1_PRIMARY_PHONE_NUMBER,
    NULL AS CONTACT_1_PRIMARY_PHONE_TYPE,
    NULL AS CONTACT_2_DEPARTMENT_NAME,
    NULL AS CONTACT_2_FIRST_NAME,
    NULL AS CONTACT_2_LAST_NAME,
    NULL AS CONTACT_2_PRIMARY_PHONE_NUMBER,
    NULL AS CONTACT_2_PRIMARY_PHONE_TYPE,
    NULL AS COUNTRY,
    NULL AS COUNTRY_CODE,
    NULL AS  COUNTY,
    TO_CHAR(SYSTIMESTAMP()) AS DATE_INSERTED,
    TO_CHAR(SYSTIMESTAMP()) AS DATE_UPDATED,
    NULL AS DEPARTMENT_NAME,
    NULL AS LONG_ADDRESS_NUMBER,
    NULL AS POSTAL_CODE,
    NULL AS REQUIRED_1099,
    NULL AS SOURCE_BUSINESS_UNIT_CODE,
    Null AS SOURCE_NAME,
    SOURCE_SYSTEM AS SOURCE_SYSTEM,
    SOURCE_SYSTEM_ADDRESS_NUMBER,
    NULL AS STATE_PROVINCE,
    NULL AS STATE_PROVINCE_CODE,
    NULL AS TAX_NUMBER,
    NULL AS TAX_TYPE,
    NULL AS SOURCE_PAYEE_ID,
    COMPANY_ADDRESS_GUID AS PAYEE_GUID   
from {{ ref('stg_d_wbx_company') }}
),
customer as (
select 
       ACTIVE_INDICATOR AS ACTIVE_INDICATOR,
       company_code,
       GENERIC_ADDRESS_TYPE,
       CUSTOMER_ADDRESS_NUMBER_GUID as ADDRESS_GUID,
       ADDRESS_LINE_1 AS ADDRESS_LINE_1,
       Null AS ADDRESS_LINE_2,
       Null AS ADDRESS_LINE_3,
       Null AS ADDRESS_LINE_4,
       BILL_ADDRESS_TYPE AS ADDRESS_TYPE,
       BILL_ADDRESS_TYPE_DESCRIPTION AS ADDRESS_TYPE_DESCRIPTION,
       Null AS BUSINESS_UNIT,
       CITY AS CITY,
       null as  CONTACT_1_DEPARTMENT_NAME,
null  AS CONTACT_1_EMAIL,
null as  CONTACT_1_FIRST_NAME,
null as  CONTACT_1_LAST_NAME,
null as  CONTACT_1_PRIMARY_PHONE_NUMBER,
null as  CONTACT_1_PRIMARY_PHONE_TYPE,
null as  CONTACT_2_DEPARTMENT_NAME,
null as  CONTACT_2_FIRST_NAME,
null as  CONTACT_2_LAST_NAME,
null as  CONTACT_2_PRIMARY_PHONE_NUMBER,
null as  CONTACT_2_PRIMARY_PHONE_TYPE,
         COUNTRY,
       COUNTRY_CODE,
       null as COUNTY,
       DATE_INSERTED,
       DATE_UPDATED,
       Null AS DEPARTMENT_NAME,
       LONG_ADDRESS_NUMBER AS LONG_ADDRESS_NUMBER,
       POSTAL_CODE,
       Null as REQUIRED_1099,
       NULL AS SOURCE_BUSINESS_UNIT_CODE,
       cast(substring(SOURCE_NAME,1,60) as varchar2(60)) AS SOURCE_NAME,
       SOURCE_SYSTEM,
       SOURCE_SYSTEM_ADDRESS_NUMBER,
       STATE_PROVINCE,
       STATE_PROVINCE_CODE,
       TAX_NUMBER,
       null as TAX_TYPE,
       NULL AS SOURCE_PAYEE_ID,
       CUSTOMER_ADDRESS_NUMBER_GUID  AS PAYEE_GUID
       
from ( select *, ROW_NUMBER() OVER (PARTITION BY CUSTOMER_ADDRESS_NUMBER_GUID,company_code order by company_code desc) rnk 
        from {{ ref('int_d_wbx_customer') }} where BILL_ADDRESS_TYPE <> 'FIN CO'
    )
--where rnk = 1 Removed this as part of BR2 as the address is based on company
)
, 
plant as (
select distinct
       null as ACTIVE_INDICATOR,
       company_code,
       GENERIC_ADDRESS_TYPE,
       PLANTDC_ADDRESS_GUID as ADDRESS_GUID,
       ADDRESS_LINE_1,
       null as ADDRESS_LINE_2,
       null as ADDRESS_LINE_3,
       null as ADDRESS_LINE_4,
       null as ADDRESS_TYPE,
       null as ADDRESS_TYPE_DESCRIPTION,
       BUSINESS_UNIT,
       CITY,
       null as CONTACT_1_DEPARTMENT_NAME,
       null as CONTACT_1_EMAIL,---modified
       null as CONTACT_1_FIRST_NAME,
       null as CONTACT_1_LAST_NAME,
       null as CONTACT_1_PRIMARY_PHONE_NUMBER,
       null as CONTACT_1_PRIMARY_PHONE_TYPE,
       null as CONTACT_2_DEPARTMENT_NAME,
       null as CONTACT_2_FIRST_NAME,
       null as CONTACT_2_LAST_NAME,
       null as CONTACT_2_PRIMARY_PHONE_NUMBER,
       null as CONTACT_2_PRIMARY_PHONE_TYPE,
       COUNTRY,
       COUNTRY_CODE,
       COUNTY,
       DATE_INSERTED,
       DATE_UPDATED,
       null as DEPARTMENT_NAME,
       null as LONG_ADDRESS_NUMBER,
       POSTAL_CODE,
       null as REQUIRED_1099,
       SOURCE_BUSINESS_UNIT_CODE,
       null as SOURCE_NAME,
       SOURCE_SYSTEM,
       SOURCE_SYSTEM_ADDRESS_NUMBER,
       STATE_PROVINCE,
       STATE_PROVINCE_CODE,
       null as TAX_NUMBER,
       null as TAX_TYPE,
       null as SOURCE_PAYEE_ID,
       PLANTDC_ADDRESS_GUID as PAYEE_GUID
from {{ ref('int_d_wbx_plant_dc') }}
)
, supplier as (
    SELECT 
       null as ACTIVE_INDICATOR,
       company_code,
       GENERIC_ADDRESS_TYPE,
       SUPPLIER_ADDRESS_NUMBER_GUID as ADDRESS_GUID,
       ADDRESS_LINE_1,
       null as ADDRESS_LINE_2,
       null as ADDRESS_LINE_3,
       null as ADDRESS_LINE_4,
       ADDRESS_TYPE,
       ADDRESS_TYPE_DESCRIPTION,
       null as BUSINESS_UNIT,
       CITY,
       null as CONTACT_1_DEPARTMENT_NAME,
       null as CONTACT_1_EMAIL,
       null as CONTACT_1_FIRST_NAME,
       null as CONTACT_1_LAST_NAME,
       null as CONTACT_1_PRIMARY_PHONE_NUMBER,
       null as CONTACT_1_PRIMARY_PHONE_TYPE,
       null as CONTACT_2_DEPARTMENT_NAME,
       null as CONTACT_2_FIRST_NAME,
       null as CONTACT_2_LAST_NAME,
       null as CONTACT_2_PRIMARY_PHONE_NUMBER,
       null as CONTACT_2_PRIMARY_PHONE_TYPE,
       COUNTRY,
       COUNTRY_CODE,
       null as COUNTY,
       DATE_INSERTED,
       DATE_UPDATED,
       null  AS DEPARTMENT_NAME,
       LONG_ADDRESS_NUMBER,
       POSTAL_CODE,
       null as REQUIRED_1099,
       null AS SOURCE_BUSINESS_UNIT_CODE,
       SOURCE_NAME,
       SOURCE_SYSTEM,
       SOURCE_SYSTEM_ADDRESS_NUMBER,
       STATE_PROVINCE,
       STATE_PROVINCE_CODE,
       TAX_NUMBER,
       null as TAX_TYPE,
       null as SOURCE_PAYEE_ID,
       ADDRESS_GUID AS PAYEE_GUID
from {{ ref('int_d_wbx_supplier') }}
)
, adr_union as (
select distinct 
    ACTIVE_INDICATOR,
    company_code,
    GENERIC_ADDRESS_TYPE,
    ADDRESS_GUID,
    ADDRESS_LINE_1,
    ADDRESS_LINE_2,
    ADDRESS_LINE_3,
    ADDRESS_LINE_4,
    ADDRESS_TYPE,
    ADDRESS_TYPE_DESCRIPTION,
    BUSINESS_UNIT,
    CITY,
    CONTACT_1_DEPARTMENT_NAME,
    CONTACT_1_EMAIL,
    CONTACT_1_FIRST_NAME,
    CONTACT_1_LAST_NAME,
    CONTACT_1_PRIMARY_PHONE_NUMBER,
    CONTACT_1_PRIMARY_PHONE_TYPE,
    CONTACT_2_DEPARTMENT_NAME,
    CONTACT_2_FIRST_NAME,
    CONTACT_2_LAST_NAME,
    CONTACT_2_PRIMARY_PHONE_NUMBER,
    CONTACT_2_PRIMARY_PHONE_TYPE,
    COUNTRY,
    COUNTRY_CODE,
    COUNTY,
    DATE_INSERTED,
    DATE_UPDATED,
    DEPARTMENT_NAME,
    LONG_ADDRESS_NUMBER,
    POSTAL_CODE,
    REQUIRED_1099,
    SOURCE_BUSINESS_UNIT_CODE,
    SOURCE_NAME,
    SOURCE_SYSTEM,
    SOURCE_SYSTEM_ADDRESS_NUMBER,
    STATE_PROVINCE,
    STATE_PROVINCE_CODE,
    TAX_NUMBER,
    TAX_TYPE,
    SOURCE_PAYEE_ID,
    PAYEE_GUID,
    '1' as seq
from plant

UNION

select distinct 
    ACTIVE_INDICATOR,
    company_code,
    GENERIC_ADDRESS_TYPE,
    ADDRESS_GUID,
    ADDRESS_LINE_1,
    ADDRESS_LINE_2,
    ADDRESS_LINE_3,
    ADDRESS_LINE_4,
    ADDRESS_TYPE,
    ADDRESS_TYPE_DESCRIPTION,
    BUSINESS_UNIT,
    CITY,
    CONTACT_1_DEPARTMENT_NAME,
    CONTACT_1_EMAIL,
    CONTACT_1_FIRST_NAME,
    CONTACT_1_LAST_NAME,
    CONTACT_1_PRIMARY_PHONE_NUMBER,
    CONTACT_1_PRIMARY_PHONE_TYPE,
    CONTACT_2_DEPARTMENT_NAME,
    CONTACT_2_FIRST_NAME,
    CONTACT_2_LAST_NAME,
    CONTACT_2_PRIMARY_PHONE_NUMBER,
    CONTACT_2_PRIMARY_PHONE_TYPE,
    COUNTRY,
    COUNTRY_CODE,
    COUNTY,
    DATE_INSERTED,
    DATE_UPDATED,
    DEPARTMENT_NAME,
    LONG_ADDRESS_NUMBER,
    POSTAL_CODE,
    REQUIRED_1099,
    SOURCE_BUSINESS_UNIT_CODE,
    SOURCE_NAME,
    SOURCE_SYSTEM,
    SOURCE_SYSTEM_ADDRESS_NUMBER,
    STATE_PROVINCE,
    STATE_PROVINCE_CODE,
    TAX_NUMBER,
    TAX_TYPE,
    SOURCE_PAYEE_ID,
    PAYEE_GUID,
    '2' as seq
from company

UNION

select distinct 
    ACTIVE_INDICATOR,
    company_code,
    GENERIC_ADDRESS_TYPE,
    ADDRESS_GUID,
    ADDRESS_LINE_1,
    ADDRESS_LINE_2,
    ADDRESS_LINE_3,
    ADDRESS_LINE_4,
    ADDRESS_TYPE,
    ADDRESS_TYPE_DESCRIPTION,
    BUSINESS_UNIT,
    CITY,
    CONTACT_1_DEPARTMENT_NAME,
    CONTACT_1_EMAIL,
    CONTACT_1_FIRST_NAME,
    CONTACT_1_LAST_NAME,
    CONTACT_1_PRIMARY_PHONE_NUMBER,
    CONTACT_1_PRIMARY_PHONE_TYPE,
    CONTACT_2_DEPARTMENT_NAME,
    CONTACT_2_FIRST_NAME,
    CONTACT_2_LAST_NAME,
    CONTACT_2_PRIMARY_PHONE_NUMBER,
    CONTACT_2_PRIMARY_PHONE_TYPE,
    COUNTRY,
    COUNTRY_CODE,
    COUNTY,
    DATE_INSERTED,
    DATE_UPDATED,
    DEPARTMENT_NAME,
    LONG_ADDRESS_NUMBER,
    POSTAL_CODE,
    REQUIRED_1099,
    SOURCE_BUSINESS_UNIT_CODE,
    SOURCE_NAME,
    SOURCE_SYSTEM,
    SOURCE_SYSTEM_ADDRESS_NUMBER,
    STATE_PROVINCE,
    STATE_PROVINCE_CODE,
    TAX_NUMBER,
    TAX_TYPE,
    SOURCE_PAYEE_ID,
    PAYEE_GUID,
    '3' as seq
from customer


UNION

select distinct 
    ACTIVE_INDICATOR,
    company_code,
    GENERIC_ADDRESS_TYPE,
    ADDRESS_GUID,
    ADDRESS_LINE_1,
    ADDRESS_LINE_2,
    ADDRESS_LINE_3,
    ADDRESS_LINE_4,
    ADDRESS_TYPE,
    ADDRESS_TYPE_DESCRIPTION,
    BUSINESS_UNIT,
    CITY,
    CONTACT_1_DEPARTMENT_NAME,
    CONTACT_1_EMAIL,
    CONTACT_1_FIRST_NAME,
    CONTACT_1_LAST_NAME,
    CONTACT_1_PRIMARY_PHONE_NUMBER,
    CONTACT_1_PRIMARY_PHONE_TYPE,
    CONTACT_2_DEPARTMENT_NAME,
    CONTACT_2_FIRST_NAME,
    CONTACT_2_LAST_NAME,
    CONTACT_2_PRIMARY_PHONE_NUMBER,
    CONTACT_2_PRIMARY_PHONE_TYPE,
    COUNTRY,
    COUNTRY_CODE,
    COUNTY,
    DATE_INSERTED,
    DATE_UPDATED,
    DEPARTMENT_NAME,
    LONG_ADDRESS_NUMBER,
    POSTAL_CODE,
    REQUIRED_1099,
    SOURCE_BUSINESS_UNIT_CODE,
    SOURCE_NAME,
    SOURCE_SYSTEM,
    SOURCE_SYSTEM_ADDRESS_NUMBER,
    STATE_PROVINCE,
    STATE_PROVINCE_CODE,
    TAX_NUMBER,
    TAX_TYPE,
    SOURCE_PAYEE_ID,
    PAYEE_GUID,
    '4' as seq
from supplier
)
select {{ dbt_utils.surrogate_key(['SOURCE_SYSTEM','COMPANY_CODE']) }} as company_code_guid,* from adr_union