{{ config(materialized=env_var("DBT_MAT_VIEW"), tags=["sales","promo","sales_promo_summary","sls_promo"]) }}

with cte_sls_promo as (select 
promo_idx,
plan_source_customer_code,
source_system,
calendar_date,
snapshot_date,
ispromosku,
iscannibsku,
si_b_vol_cse,
si_a_vol_cse,
si_t_vol_cse,
si_m_vol_cse,
si_i_vol_cse,
si_b_vol_kg,
si_a_vol_kg,
si_t_vol_kg,
si_m_vol_kg,
actuals_tot_vol_kg,
base_tot_vol_kg,
forecast_tot_vol_kg,
si_i_vol_kg,
actuals_ap_gross_sales_value,
actuals_ap_range_support_allowance,
actuals_ap_everyday_low_prices,
actuals_ap_permanent_disc,
actuals_ap_off_invoice_disc,
actuals_ap_invoiced_sales_value,
actuals_ap_early_settlement_disc,
actuals_ap_growth_incentives,
actuals_ap_net_sales_value,
actuals_ap_retro,
actuals_ap_avp_disc,
actuals_ap_variable_trade,
actuals_ap_promo_fixed_funding,
actuals_ap_range_support_incentives,
actuals_ap_net_net_sales_value,
actuals_ap_direct_shopper_marketing,
actuals_ap_other_direct_payments,
actuals_ap_indirect_shopper_marketing,
actuals_ap_other_indirect_payments,
actuals_ap_fixed_trade_cust_invoiced,
actuals_ap_total_trade_cust_invoiced,
actuals_ap_fixed_trade_non_cust_invoiced,
actuals_ap_total_trade,
actuals_ap_net_realisable_revenue,
actuals_ap_tot_prime_cost_standard,
actuals_ap_gross_margin_standard,
actuals_ap_gcat_standard,
actuals_retail_tot_vol_kg,
actuals_ap_retail_revenue_mrrsp,
actuals_ap_retail_revenue_rsp,
actuals_ap_retail_revenue_net,
actuals_ap_retail_cost_of_sales,
actuals_ap_retail_retailer_retro_funding,
actuals_ap_retail_margin_excl_fixed_funding,
actuals_ap_retail_promo_fixed_spend,
actuals_ap_retail_total_spend,
actuals_ap_retail_margin_incl_fixed_funding,
actuals_ap_retail_revenue_net_excl_mrrsp,
actuals_ap_retail_revenue_net_excl_rsp,
base_ap_gross_sales_value,
base_ap_range_support_allowance,
base_ap_everyday_low_prices,
base_ap_permanent_disc,
base_ap_off_invoice_disc,
base_ap_invoiced_sales_value,
base_ap_early_settlement_disc,
base_ap_growth_incentives,
base_ap_net_sales_value,
base_ap_retro,
base_ap_avp_disc,
base_ap_variable_trade,
base_ap_promo_fixed_funding,
base_ap_range_support_incentives,
base_ap_net_net_sales_value,
base_ap_direct_shopper_marketing,
base_ap_other_direct_payments,
base_ap_indirect_shopper_marketing,
base_ap_other_indirect_payments,
base_ap_fixed_trade_cust_invoiced,
base_ap_total_trade_cust_invoiced,
base_ap_fixed_trade_non_cust_invoiced,
base_ap_total_trade,
base_ap_net_realisable_revenue,
base_ap_tot_prime_cost_standard,
base_ap_gross_margin_standard,
base_ap_gcat_standard,
base_retail_tot_vol_kg,
base_ap_retail_revenue_mrrsp,
base_ap_retail_revenue_rsp,
base_ap_retail_revenue_net,
base_ap_retail_cost_of_sales,
base_ap_retail_retailer_retro_funding,
base_ap_retail_margin_excl_fixed_funding,
base_ap_retail_promo_fixed_spend,
base_ap_retail_total_spend,
base_ap_retail_margin_incl_fixed_funding,
base_ap_retail_revenue_net_excl_mrrsp,
base_ap_retail_revenue_net_excl_rsp,
forecast_ap_gross_sales_value,
forecast_ap_range_support_allowance,
forecast_ap_everyday_low_prices,
forecast_ap_permanent_disc,
forecast_ap_off_invoice_disc,
forecast_ap_invoiced_sales_value,
forecast_ap_early_settlement_disc,
forecast_ap_growth_incentives,
forecast_ap_net_sales_value,
forecast_ap_retro,
forecast_ap_avp_disc,
forecast_ap_variable_trade,
forecast_ap_promo_fixed_funding,
forecast_ap_range_support_incentives,
forecast_ap_net_net_sales_value,
forecast_ap_direct_shopper_marketing,
forecast_ap_other_direct_payments,
forecast_ap_indirect_shopper_marketing,
forecast_ap_other_indirect_payments,
forecast_ap_fixed_trade_cust_invoiced,
forecast_ap_total_trade_cust_invoiced,
forecast_ap_fixed_trade_non_cust_invoiced,
forecast_ap_total_trade,
forecast_ap_total_trade_gbp,
forecast_ap_net_realisable_revenue,
forecast_ap_tot_prime_cost_standard,
forecast_ap_gross_margin_standard,
forecast_ap_gcat_standard,
forecast_retail_tot_vol_kg,
forecast_ap_retail_revenue_mrrsp,
forecast_ap_retail_revenue_rsp,
forecast_ap_retail_revenue_net,
forecast_ap_retail_cost_of_sales,
forecast_ap_retail_retailer_retro_funding,
forecast_ap_retail_margin_excl_fixed_funding,
forecast_ap_retail_promo_fixed_spend,
forecast_ap_retail_total_spend,
forecast_ap_retail_margin_incl_fixed_funding,
forecast_ap_retail_revenue_net_excl_mrrsp,
forecast_ap_retail_revenue_net_excl_rsp,
actuals_tot_vol_ca,
actuals_tot_vol_ul,
base_tot_vol_ca,
base_tot_vol_ul,
forecast_tot_vol_ca,
forecast_tot_vol_ul,
item_guid,
prm_rpt_customer_guid,
source_item_identifier,
promo_guid
 from {{ ref('fct_wbx_sls_promo') }}), --R_EI_SYSADM.SLS_WTX_PROMO_FACT , check if guid of this and b/w dim promo guid matching
cte_sls_promo_dim as (select 
source_system,
promo_id,
promo_code,
promo_desc,
promo_tactic_desc,
promo_sub_tactic_desc,
promo_sub_tactic_discount,
promo_sub_tactic_isactive,
promo_stat_desc,
promo_phase_desc,
promo_phase_length,
promo_phase_effect_desc,
promo_phase_type_desc,
promo_phase_type_unit,
authorized_user_name,
buy_in_start_dt,
buy_in_end_dt,
in_store_start_dt,
in_store_end_dt,
performance_start_dt,
performance_end_dt,
feature,
feature_desc,
promo_mechanic_name,
SNAPSHOT_DATE,
promo_guid
 from {{ ref('dim_wbx_promo') }}),  --EI_RDM.SLS_WTX_PROMO_DIM
 --changed from src_sls_wtx_lkp_snapshot_date to stg_d_wtx_lkp_snapshot_date
cte_sls_wtx_lkp_snapshot_date as (select * from {{ref('stg_d_wtx_lkp_snapshot_date')}}), --R_EI_SYSADM.SLS_WTX_lkp_snapshot_date
cte_snapshot_fc_dim as (Select * from {{ ref('dim_wbx_fc_snapshot') }}),
cte_customer_ext as (select * from {{ ref('dim_wbx_customer_ext') }}),
cte_dim_date as (select * from {{ ref('src_dim_date') }}),
cte_planning_Date_oc as (select * from {{ ref('dim_wbx_planning_date_oc') }}),
cte_item_ext as (select * from {{ ref('dim_wbx_item_ext') }}),
cte_customer as (select * from {{ ref('dim_wbx_customer') }}),
cte_budget_promo as (select 
* from {{ ref('fct_wbx_sls_budget_promo') }}),
cte_sls_wtx_budget_scen_xref as (select * from {{ ref('src_sls_wtx_budget_scen_xref') }}), --EI_RDM.SLS_WTX_BUDGET_SCEN_XREF
cte_promo_dim_hist as (select * from {{ ref('dim_wbx_promo_hist') }}),
cte_v_wtx_cust_planning as --cte for the view POSTSNOWP.EI_RDM.v_wtx_cust_planning
(
    select * from {{ref('dim_wbx_cust_planning')}} where COMPANY_CODE='WBX'
),
cte_final as 
(
    SELECT  
PROMO_FACT.SOURCE_SYSTEM,
PROMO_FACT.SOURCE_ITEM_IDENTIFIER,
TRIM(PROMO_FACT.PLAN_SOURCE_CUSTOMER_CODE) AS PLAN_SOURCE_CUSTOMER_CODE,
PROMO_FACT.CALENDAR_DATE,
PROMO_FACT.SNAPSHOT_DATE,
'DAILY' AS FROZEN_FORECAST,--HJ 07 sep 2021,added frozen forecast
NULL AS FROZEN_FORECAST_DELINEATION_DATE,
'PROMOTIONS' AS SOURCE_CONTENT_FILTER,
PROMO_FACT.ISPROMOSKU,
PROMO_FACT.ISCANNIBSKU,
PROMO_FACT.SI_B_VOL_CSE,
PROMO_FACT.SI_A_VOL_CSE,
PROMO_FACT.SI_T_VOL_CSE,
PROMO_FACT.SI_M_VOL_CSE,
PROMO_FACT.SI_I_VOL_CSE,
PROMO_FACT.SI_B_VOL_KG,
PROMO_FACT.SI_A_VOL_KG,
PROMO_FACT.SI_T_VOL_KG,
PROMO_FACT.SI_M_VOL_KG,
PROMO_FACT.ACTUALS_TOT_VOL_KG,
PROMO_FACT.BASE_TOT_VOL_KG,
PROMO_FACT.FORECAST_TOT_VOL_KG,
PROMO_FACT.SI_I_VOL_KG,
PROMO_FACT.ACTUALS_AP_GROSS_SALES_VALUE,
PROMO_FACT.ACTUALS_AP_RANGE_SUPPORT_ALLOWANCE,
PROMO_FACT.ACTUALS_AP_EVERYDAY_LOW_PRICES,
PROMO_FACT.ACTUALS_AP_PERMANENT_DISC,
PROMO_FACT.ACTUALS_AP_OFF_INVOICE_DISC,
PROMO_FACT.ACTUALS_AP_INVOICED_SALES_VALUE,
PROMO_FACT.ACTUALS_AP_EARLY_SETTLEMENT_DISC,
PROMO_FACT.ACTUALS_AP_GROWTH_INCENTIVES,
PROMO_FACT.ACTUALS_AP_NET_SALES_VALUE,
PROMO_FACT.ACTUALS_AP_RETRO,
PROMO_FACT.ACTUALS_AP_AVP_DISC,
PROMO_FACT.ACTUALS_AP_VARIABLE_TRADE,
PROMO_FACT.ACTUALS_AP_PROMO_FIXED_FUNDING,
PROMO_FACT.ACTUALS_AP_RANGE_SUPPORT_INCENTIVES,
PROMO_FACT.ACTUALS_AP_NET_NET_SALES_VALUE,
PROMO_FACT.ACTUALS_AP_DIRECT_SHOPPER_MARKETING,
PROMO_FACT.ACTUALS_AP_OTHER_DIRECT_PAYMENTS,
PROMO_FACT.ACTUALS_AP_INDIRECT_SHOPPER_MARKETING,
PROMO_FACT.ACTUALS_AP_OTHER_INDIRECT_PAYMENTS,
PROMO_FACT.ACTUALS_AP_FIXED_TRADE_CUST_INVOICED,
PROMO_FACT.ACTUALS_AP_TOTAL_TRADE_CUST_INVOICED,
PROMO_FACT.ACTUALS_AP_FIXED_TRADE_NON_CUST_INVOICED,
PROMO_FACT.ACTUALS_AP_TOTAL_TRADE,
PROMO_FACT.ACTUALS_AP_NET_REALISABLE_REVENUE,
PROMO_FACT.ACTUALS_AP_TOT_PRIME_COST_STANDARD,
PROMO_FACT.ACTUALS_AP_GROSS_MARGIN_STANDARD,
PROMO_FACT.ACTUALS_AP_GCAT_STANDARD,
PROMO_FACT.ACTUALS_RETAIL_TOT_VOL_KG,
PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_MRRSP,
PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_RSP,
PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_NET,
PROMO_FACT.ACTUALS_AP_RETAIL_COST_OF_SALES,
PROMO_FACT.ACTUALS_AP_RETAIL_RETAILER_RETRO_FUNDING,
PROMO_FACT.ACTUALS_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
PROMO_FACT.ACTUALS_AP_RETAIL_PROMO_FIXED_SPEND,
PROMO_FACT.ACTUALS_AP_RETAIL_TOTAL_SPEND,
PROMO_FACT.ACTUALS_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_NET_EXCL_RSP,
PROMO_FACT.BASE_AP_GROSS_SALES_VALUE,
PROMO_FACT.BASE_AP_RANGE_SUPPORT_ALLOWANCE,
PROMO_FACT.BASE_AP_EVERYDAY_LOW_PRICES,
PROMO_FACT.BASE_AP_PERMANENT_DISC,
PROMO_FACT.BASE_AP_OFF_INVOICE_DISC,
PROMO_FACT.BASE_AP_INVOICED_SALES_VALUE,
PROMO_FACT.BASE_AP_EARLY_SETTLEMENT_DISC,
PROMO_FACT.BASE_AP_GROWTH_INCENTIVES,
PROMO_FACT.BASE_AP_NET_SALES_VALUE,
PROMO_FACT.BASE_AP_RETRO,
PROMO_FACT.BASE_AP_AVP_DISC,
PROMO_FACT.BASE_AP_VARIABLE_TRADE,
PROMO_FACT.BASE_AP_PROMO_FIXED_FUNDING,
PROMO_FACT.BASE_AP_RANGE_SUPPORT_INCENTIVES,
PROMO_FACT.BASE_AP_NET_NET_SALES_VALUE,
PROMO_FACT.BASE_AP_DIRECT_SHOPPER_MARKETING,
PROMO_FACT.BASE_AP_OTHER_DIRECT_PAYMENTS,
PROMO_FACT.BASE_AP_INDIRECT_SHOPPER_MARKETING,
PROMO_FACT.BASE_AP_OTHER_INDIRECT_PAYMENTS,
PROMO_FACT.BASE_AP_FIXED_TRADE_CUST_INVOICED,
PROMO_FACT.BASE_AP_TOTAL_TRADE_CUST_INVOICED,
PROMO_FACT.BASE_AP_FIXED_TRADE_NON_CUST_INVOICED,
PROMO_FACT.BASE_AP_TOTAL_TRADE,
PROMO_FACT.BASE_AP_NET_REALISABLE_REVENUE,
PROMO_FACT.BASE_AP_TOT_PRIME_COST_STANDARD,
PROMO_FACT.BASE_AP_GROSS_MARGIN_STANDARD,
PROMO_FACT.BASE_AP_GCAT_STANDARD,
PROMO_FACT.BASE_RETAIL_TOT_VOL_KG,
PROMO_FACT.BASE_AP_RETAIL_REVENUE_MRRSP,
PROMO_FACT.BASE_AP_RETAIL_REVENUE_RSP,
PROMO_FACT.BASE_AP_RETAIL_REVENUE_NET,
PROMO_FACT.BASE_AP_RETAIL_COST_OF_SALES,
PROMO_FACT.BASE_AP_RETAIL_RETAILER_RETRO_FUNDING,
PROMO_FACT.BASE_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
PROMO_FACT.BASE_AP_RETAIL_PROMO_FIXED_SPEND,
PROMO_FACT.BASE_AP_RETAIL_TOTAL_SPEND,
PROMO_FACT.BASE_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
PROMO_FACT.BASE_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
PROMO_FACT.BASE_AP_RETAIL_REVENUE_NET_EXCL_RSP,
PROMO_FACT.FORECAST_AP_GROSS_SALES_VALUE,
PROMO_FACT.FORECAST_AP_RANGE_SUPPORT_ALLOWANCE,
PROMO_FACT.FORECAST_AP_EVERYDAY_LOW_PRICES,
PROMO_FACT.FORECAST_AP_PERMANENT_DISC,
PROMO_FACT.FORECAST_AP_OFF_INVOICE_DISC,
PROMO_FACT.FORECAST_AP_INVOICED_SALES_VALUE,
PROMO_FACT.FORECAST_AP_EARLY_SETTLEMENT_DISC,
PROMO_FACT.FORECAST_AP_GROWTH_INCENTIVES,
PROMO_FACT.FORECAST_AP_NET_SALES_VALUE,
PROMO_FACT.FORECAST_AP_RETRO,
PROMO_FACT.FORECAST_AP_AVP_DISC,
PROMO_FACT.FORECAST_AP_VARIABLE_TRADE,
PROMO_FACT.FORECAST_AP_PROMO_FIXED_FUNDING,
PROMO_FACT.FORECAST_AP_RANGE_SUPPORT_INCENTIVES,
PROMO_FACT.FORECAST_AP_NET_NET_SALES_VALUE,
PROMO_FACT.FORECAST_AP_DIRECT_SHOPPER_MARKETING,
PROMO_FACT.FORECAST_AP_OTHER_DIRECT_PAYMENTS,
PROMO_FACT.FORECAST_AP_INDIRECT_SHOPPER_MARKETING,
PROMO_FACT.FORECAST_AP_OTHER_INDIRECT_PAYMENTS,
PROMO_FACT.FORECAST_AP_FIXED_TRADE_CUST_INVOICED,
PROMO_FACT.FORECAST_AP_TOTAL_TRADE_CUST_INVOICED,
PROMO_FACT.FORECAST_AP_FIXED_TRADE_NON_CUST_INVOICED,
PROMO_FACT.FORECAST_AP_TOTAL_TRADE,
PROMO_FACT.FORECAST_AP_TOTAL_TRADE_GBP,
PROMO_FACT.FORECAST_AP_NET_REALISABLE_REVENUE,
PROMO_FACT.FORECAST_AP_TOT_PRIME_COST_STANDARD,
PROMO_FACT.FORECAST_AP_GROSS_MARGIN_STANDARD,
PROMO_FACT.FORECAST_AP_GCAT_STANDARD,
PROMO_FACT.FORECAST_RETAIL_TOT_VOL_KG,
PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_MRRSP,
PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_RSP,
PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_NET,
PROMO_FACT.FORECAST_AP_RETAIL_COST_OF_SALES,
PROMO_FACT.FORECAST_AP_RETAIL_RETAILER_RETRO_FUNDING,
PROMO_FACT.FORECAST_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
PROMO_FACT.FORECAST_AP_RETAIL_PROMO_FIXED_SPEND,
PROMO_FACT.FORECAST_AP_RETAIL_TOTAL_SPEND,
PROMO_FACT.FORECAST_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_NET_EXCL_RSP,
PROMO_FACT.ACTUALS_TOT_VOL_CA,
PROMO_FACT.ACTUALS_TOT_VOL_UL,
PROMO_FACT.BASE_TOT_VOL_CA,
PROMO_FACT.BASE_TOT_VOL_UL,
PROMO_FACT.FORECAST_TOT_VOL_CA,
PROMO_FACT.FORECAST_TOT_VOL_UL,
PROMO_FACT.ACTUALS_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS AS PRM_ACTUALS_TOT_VOL_CU,
PROMO_FACT.BASE_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS AS PRM_BASE_TOT_VOL_CU,
PROMO_FACT.FORECAST_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS AS PRM_FORECAST_TOT_VOL_CU,
PROMO_FACT.SI_B_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_B_VOL_CU,
PROMO_FACT.SI_A_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_A_VOL_CU,
PROMO_FACT.SI_T_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_T_VOL_CU,
PROMO_FACT.SI_M_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_M_VOL_CU,
PROMO_FACT.SI_I_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_I_VOL_CU,
PROMO_FACT.ACTUALS_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_ACTUALS_TOT_VOL_PK,
PROMO_FACT.BASE_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_BASE_TOT_VOL_PK,
PROMO_FACT.FORECAST_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_FORECAST_TOT_VOL_PK,
PROMO_FACT.SI_B_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_B_VOL_PK,
PROMO_FACT.SI_A_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_A_VOL_PK,
PROMO_FACT.SI_T_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_T_VOL_PK,
PROMO_FACT.SI_M_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_M_VOL_PK,
PROMO_FACT.SI_I_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_I_VOL_PK,
PROMO_DIM.PROMO_ID,
PROMO_DIM.PROMO_CODE,
PROMO_DIM.PROMO_DESC,
PROMO_DIM.PROMO_TACTIC_DESC,
PROMO_DIM.PROMO_SUB_TACTIC_DESC,
PROMO_DIM.PROMO_SUB_TACTIC_DISCOUNT,
PROMO_DIM.PROMO_SUB_TACTIC_ISACTIVE,
PROMO_DIM.PROMO_STAT_DESC,
PROMO_DIM.PROMO_PHASE_DESC,
PROMO_DIM.PROMO_PHASE_LENGTH,
PROMO_DIM.PROMO_PHASE_EFFECT_DESC,
PROMO_DIM.PROMO_PHASE_TYPE_DESC,
PROMO_DIM.PROMO_PHASE_TYPE_UNIT,
PROMO_DIM.AUTHORIZED_USER_NAME,
PROMO_DIM.BUY_IN_START_DT,
PROMO_DIM.BUY_IN_END_DT,
PROMO_DIM.IN_STORE_START_DT,
PROMO_DIM.IN_STORE_END_DT,
PROMO_DIM.PERFORMANCE_START_DT,
PROMO_DIM.PERFORMANCE_END_DT,
PROMO_DIM.FEATURE,
PROMO_DIM.FEATURE_DESC,
PROMO_DIM.PROMO_MECHANIC_NAME,
PLAN.MARKET AS MARKET,
PLAN.SUB_MARKET AS SUBMARKET,
PLAN.TRADE_CLASS AS TRADE_CLASS,
PLAN.TRADE_GROUP AS TRADE_GROUP,
PLAN.TRADE_TYPE AS TRADE_TYPE,
PLAN.TRADE_SECTOR_DESC AS TRADE_SECTOR,
ITM_EXT.DESCRIPTION,
ITM_EXT.ITEM_TYPE, 
ITM_EXT.BRANDING_DESC, 
ITM_EXT.PRODUCT_CLASS_DESC, 
ITM_EXT.SUB_PRODUCT_DESC, 
ITM_EXT.STRATEGIC_DESC, 
ITM_EXT.POWER_BRAND_DESC, 
ITM_EXT.MANUFACTURING_GROUP_DESC, 
ITM_EXT.CATEGORY_DESC, 
ITM_EXT.PACK_SIZE_DESC, 
ITM_EXT.SUB_CATEGORY_DESC,
ITM_EXT.PROMO_TYPE_DESC,
DT.REPORT_FISCAL_YEAR,
DT.REPORT_FISCAL_YEAR_PERIOD_NO,
DT.FISCAL_YEAR_BEGIN_DT,
DT.FISCAL_YEAR_END_DT,
DTP.PLANNING_WEEK_CODE,
DTP.PLANNING_WEEK_START_DT,
DTP.PLANNING_WEEK_END_DT,
DTP.PLANNING_WEEK_NO,
DTP.PLANNING_MONTH_CODE,
DTP.PLANNING_MONTH_START_DT,
DTP.PLANNING_MONTH_END_DT,
DTP.PLANNING_QUARTER_NO,
DTP.PLANNING_QUARTER_START_DT,
DTP.PLANNING_QUARTER_END_DT,
DTP.PLANNING_YEAR_NO,
DTP.PLANNING_YEAR_START_DT,
DTP.PLANNING_YEAR_END_DT,
CUST.BILL_NAME
FROM cte_sls_promo PROMO_FACT
INNER JOIN
(SELECT MAX(SNAPSHOT_DATE) AS SNAPSHOT_DATE FROM cte_sls_wtx_lkp_snapshot_date
UNION select SNAPSHOT_DATE from
    (SELECT *,
    RANK () OVER (
    PARTITION BY SOURCE_SYSTEM,SNAPSHOT_DATE,SNAPSHOT_MODEL,SNAPSHOT_CODE
    ORDER BY SNAPSHOT_TYPE ASC
    ) RANK_NO
FROM cte_snapshot_fc_dim WHERE SNAPSHOT_TYPE = 'WEEK_END') where rank_no=1) D
ON PROMO_FACT.SNAPSHOT_DATE = D.SNAPSHOT_DATE
LEFT JOIN cte_dim_date DT
    ON PROMO_FACT.CALENDAR_DATE = DT.CALENDAR_DATE
LEFT JOIN cte_planning_Date_oc DTP
    ON PROMO_FACT.SOURCE_SYSTEM = DTP.SOURCE_SYSTEM
    AND PROMO_FACT.CALENDAR_DATE = DTP.CALENDAR_DATE
LEFT JOIN (SELECT SOURCE_SYSTEM, ITEM_GUID, MAX(ITEM_TYPE) AS ITEM_TYPE, MAX(BRANDING_DESC) AS BRANDING_DESC, MAX(PRODUCT_CLASS_DESC) AS PRODUCT_CLASS_DESC, MAX(SUB_PRODUCT_DESC) AS SUB_PRODUCT_DESC
            , MAX(STRATEGIC_DESC) AS STRATEGIC_DESC, MAX(POWER_BRAND_DESC) AS POWER_BRAND_DESC, MAX(MANUFACTURING_GROUP_DESC) AS MANUFACTURING_GROUP_DESC
            , MAX(CATEGORY_DESC) AS CATEGORY_DESC, MAX(PACK_SIZE_DESC) AS PACK_SIZE_DESC, MAX(SUB_CATEGORY_DESC) AS SUB_CATEGORY_DESC
            , MAX(CONSUMER_UNITS_IN_TRADE_UNITS) AS CONSUMER_UNITS_IN_TRADE_UNITS, MAX(PROMO_TYPE_DESC) AS PROMO_TYPE_DESC, MAX(CONSUMER_UNITS) AS CONSUMER_UNITS,
            MAX(DESCRIPTION) AS DESCRIPTION
            FROM cte_item_ext 
            GROUP BY SOURCE_SYSTEM, ITEM_GUID) ITM_EXT
    ON PROMO_FACT.SOURCE_SYSTEM = ITM_EXT.SOURCE_SYSTEM
    AND PROMO_FACT.ITEM_GUID = ITM_EXT.ITEM_GUID
LEFT JOIN cte_v_wtx_cust_planning PLAN
    ON TRIM(PROMO_FACT.PLAN_SOURCE_CUSTOMER_CODE) = TRIM(PLAN.TRADE_TYPE_CODE)
LEFT JOIN cte_sls_promo_dim PROMO_DIM
    ON PROMO_FACT.PROMO_GUID = PROMO_DIM.PROMO_GUID
    AND PROMO_FACT.SNAPSHOT_DATE = PROMO_DIM.SNAPSHOT_DATE 
LEFT JOIN (select distinct SOURCE_SYSTEM,CUSTOMER_ADDRESS_NUMBER_GUID,COMPANY_CODE,BILL_NAME from cte_customer
where BILL_NAME is not null and COMPANY_CODE='WBX') CUST
ON PROMO_FACT.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
 AND PROMO_FACT.PRM_RPT_CUSTOMER_GUID = CUST.CUSTOMER_ADDRESS_NUMBER_GUID
WHERE PROMO_FACT.SNAPSHOT_DATE >= DATEADD(WEEK, -13, CURRENT_DATE)

UNION ALL

--HJ 07 sep 2021,added a new block for  Budget promotions(reasds from SLS_WTX_BUDGET_BUDGET_PROMO_FACT)
SELECT  
BUDGET_PROMO_FACT.SOURCE_SYSTEM,
SOURCE_ITEM_IDENTIFIER,
TRIM(PLAN_SOURCE_CUSTOMER_CODE) AS PLAN_SOURCE_CUSTOMER_CODE,
BUDGET_PROMO_FACT.CALENDAR_DATE,
BUDGET_PROMO_FACT.SNAPSHOT_DATE,
BUDGET_PROMO_FACT.FROZEN_FORECAST,
SCEN.DELINEATION_DATE AS FROZEN_FORECAST_DELINEATION_DATE,
'BUDGET_PROMOTIONS' AS SOURCE_CONTENT_FILTER,
BUDGET_PROMO_FACT.ISPROMOSKU,
BUDGET_PROMO_FACT.ISCANNIBSKU,
BUDGET_PROMO_FACT.SI_B_VOL_CSE,
BUDGET_PROMO_FACT.SI_A_VOL_CSE,
BUDGET_PROMO_FACT.SI_T_VOL_CSE,
BUDGET_PROMO_FACT.SI_M_VOL_CSE,
BUDGET_PROMO_FACT.SI_I_VOL_CSE,
BUDGET_PROMO_FACT.SI_B_VOL_KG,
BUDGET_PROMO_FACT.SI_A_VOL_KG,
BUDGET_PROMO_FACT.SI_T_VOL_KG,
BUDGET_PROMO_FACT.SI_M_VOL_KG,
BUDGET_PROMO_FACT.ACTUALS_TOT_VOL_KG,
BUDGET_PROMO_FACT.BASE_TOT_VOL_KG,
BUDGET_PROMO_FACT.FORECAST_TOT_VOL_KG,
BUDGET_PROMO_FACT.SI_I_VOL_KG,
BUDGET_PROMO_FACT.ACTUALS_AP_GROSS_SALES_VALUE,
BUDGET_PROMO_FACT.ACTUALS_AP_RANGE_SUPPORT_ALLOWANCE,
BUDGET_PROMO_FACT.ACTUALS_AP_EVERYDAY_LOW_PRICES,
BUDGET_PROMO_FACT.ACTUALS_AP_PERMANENT_DISC,
BUDGET_PROMO_FACT.ACTUALS_AP_OFF_INVOICE_DISC,
BUDGET_PROMO_FACT.ACTUALS_AP_INVOICED_SALES_VALUE,
BUDGET_PROMO_FACT.ACTUALS_AP_EARLY_SETTLEMENT_DISC,
BUDGET_PROMO_FACT.ACTUALS_AP_GROWTH_INCENTIVES,
BUDGET_PROMO_FACT.ACTUALS_AP_NET_SALES_VALUE,
BUDGET_PROMO_FACT.ACTUALS_AP_RETRO,
BUDGET_PROMO_FACT.ACTUALS_AP_AVP_DISC,
BUDGET_PROMO_FACT.ACTUALS_AP_VARIABLE_TRADE,
BUDGET_PROMO_FACT.ACTUALS_AP_PROMO_FIXED_FUNDING,
BUDGET_PROMO_FACT.ACTUALS_AP_RANGE_SUPPORT_INCENTIVES,
BUDGET_PROMO_FACT.ACTUALS_AP_NET_NET_SALES_VALUE,
BUDGET_PROMO_FACT.ACTUALS_AP_DIRECT_SHOPPER_MARKETING,
BUDGET_PROMO_FACT.ACTUALS_AP_OTHER_DIRECT_PAYMENTS,
BUDGET_PROMO_FACT.ACTUALS_AP_INDIRECT_SHOPPER_MARKETING,
BUDGET_PROMO_FACT.ACTUALS_AP_OTHER_INDIRECT_PAYMENTS,
BUDGET_PROMO_FACT.ACTUALS_AP_FIXED_TRADE_CUST_INVOICED,
BUDGET_PROMO_FACT.ACTUALS_AP_TOTAL_TRADE_CUST_INVOICED,
BUDGET_PROMO_FACT.ACTUALS_AP_FIXED_TRADE_NON_CUST_INVOICED,
BUDGET_PROMO_FACT.ACTUALS_AP_TOTAL_TRADE,
BUDGET_PROMO_FACT.ACTUALS_AP_NET_REALISABLE_REVENUE,
BUDGET_PROMO_FACT.ACTUALS_AP_TOT_PRIME_COST_STANDARD,
BUDGET_PROMO_FACT.ACTUALS_AP_GROSS_MARGIN_STANDARD,
BUDGET_PROMO_FACT.ACTUALS_AP_GCAT_STANDARD,
BUDGET_PROMO_FACT.ACTUALS_RETAIL_TOT_VOL_KG,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_MRRSP,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_RSP,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_NET,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_COST_OF_SALES,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_RETAILER_RETRO_FUNDING,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_PROMO_FIXED_SPEND,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_TOTAL_SPEND,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
BUDGET_PROMO_FACT.ACTUALS_AP_RETAIL_REVENUE_NET_EXCL_RSP,
BUDGET_PROMO_FACT.BASE_AP_GROSS_SALES_VALUE,
BUDGET_PROMO_FACT.BASE_AP_RANGE_SUPPORT_ALLOWANCE,
BUDGET_PROMO_FACT.BASE_AP_EVERYDAY_LOW_PRICES,
BUDGET_PROMO_FACT.BASE_AP_PERMANENT_DISC,
BUDGET_PROMO_FACT.BASE_AP_OFF_INVOICE_DISC,
BUDGET_PROMO_FACT.BASE_AP_INVOICED_SALES_VALUE,
BUDGET_PROMO_FACT.BASE_AP_EARLY_SETTLEMENT_DISC,
BUDGET_PROMO_FACT.BASE_AP_GROWTH_INCENTIVES,
BUDGET_PROMO_FACT.BASE_AP_NET_SALES_VALUE,
BUDGET_PROMO_FACT.BASE_AP_RETRO,
BUDGET_PROMO_FACT.BASE_AP_AVP_DISC,
BUDGET_PROMO_FACT.BASE_AP_VARIABLE_TRADE,
BUDGET_PROMO_FACT.BASE_AP_PROMO_FIXED_FUNDING,
BUDGET_PROMO_FACT.BASE_AP_RANGE_SUPPORT_INCENTIVES,
BUDGET_PROMO_FACT.BASE_AP_NET_NET_SALES_VALUE,
BUDGET_PROMO_FACT.BASE_AP_DIRECT_SHOPPER_MARKETING,
BUDGET_PROMO_FACT.BASE_AP_OTHER_DIRECT_PAYMENTS,
BUDGET_PROMO_FACT.BASE_AP_INDIRECT_SHOPPER_MARKETING,
BUDGET_PROMO_FACT.BASE_AP_OTHER_INDIRECT_PAYMENTS,
BUDGET_PROMO_FACT.BASE_AP_FIXED_TRADE_CUST_INVOICED,
BUDGET_PROMO_FACT.BASE_AP_TOTAL_TRADE_CUST_INVOICED,
BUDGET_PROMO_FACT.BASE_AP_FIXED_TRADE_NON_CUST_INVOICED,
BUDGET_PROMO_FACT.BASE_AP_TOTAL_TRADE,
BUDGET_PROMO_FACT.BASE_AP_NET_REALISABLE_REVENUE,
BUDGET_PROMO_FACT.BASE_AP_TOT_PRIME_COST_STANDARD,
BUDGET_PROMO_FACT.BASE_AP_GROSS_MARGIN_STANDARD,
BUDGET_PROMO_FACT.BASE_AP_GCAT_STANDARD,
BUDGET_PROMO_FACT.BASE_RETAIL_TOT_VOL_KG,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_REVENUE_MRRSP,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_REVENUE_RSP,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_REVENUE_NET,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_COST_OF_SALES,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_RETAILER_RETRO_FUNDING,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_PROMO_FIXED_SPEND,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_TOTAL_SPEND,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
BUDGET_PROMO_FACT.BASE_AP_RETAIL_REVENUE_NET_EXCL_RSP,
BUDGET_PROMO_FACT.FORECAST_AP_GROSS_SALES_VALUE,
BUDGET_PROMO_FACT.FORECAST_AP_RANGE_SUPPORT_ALLOWANCE,
BUDGET_PROMO_FACT.FORECAST_AP_EVERYDAY_LOW_PRICES,
BUDGET_PROMO_FACT.FORECAST_AP_PERMANENT_DISC,
BUDGET_PROMO_FACT.FORECAST_AP_OFF_INVOICE_DISC,
BUDGET_PROMO_FACT.FORECAST_AP_INVOICED_SALES_VALUE,
BUDGET_PROMO_FACT.FORECAST_AP_EARLY_SETTLEMENT_DISC,
BUDGET_PROMO_FACT.FORECAST_AP_GROWTH_INCENTIVES,
BUDGET_PROMO_FACT.FORECAST_AP_NET_SALES_VALUE,
BUDGET_PROMO_FACT.FORECAST_AP_RETRO,
BUDGET_PROMO_FACT.FORECAST_AP_AVP_DISC,
BUDGET_PROMO_FACT.FORECAST_AP_VARIABLE_TRADE,
BUDGET_PROMO_FACT.FORECAST_AP_PROMO_FIXED_FUNDING,
BUDGET_PROMO_FACT.FORECAST_AP_RANGE_SUPPORT_INCENTIVES,
BUDGET_PROMO_FACT.FORECAST_AP_NET_NET_SALES_VALUE,
BUDGET_PROMO_FACT.FORECAST_AP_DIRECT_SHOPPER_MARKETING,
BUDGET_PROMO_FACT.FORECAST_AP_OTHER_DIRECT_PAYMENTS,
BUDGET_PROMO_FACT.FORECAST_AP_INDIRECT_SHOPPER_MARKETING,
BUDGET_PROMO_FACT.FORECAST_AP_OTHER_INDIRECT_PAYMENTS,
BUDGET_PROMO_FACT.FORECAST_AP_FIXED_TRADE_CUST_INVOICED,
BUDGET_PROMO_FACT.FORECAST_AP_TOTAL_TRADE_CUST_INVOICED,
BUDGET_PROMO_FACT.FORECAST_AP_FIXED_TRADE_NON_CUST_INVOICED,
BUDGET_PROMO_FACT.FORECAST_AP_TOTAL_TRADE,
BUDGET_PROMO_FACT.FORECAST_AP_TOTAL_TRADE_GBP,
BUDGET_PROMO_FACT.FORECAST_AP_NET_REALISABLE_REVENUE,
BUDGET_PROMO_FACT.FORECAST_AP_TOT_PRIME_COST_STANDARD,
BUDGET_PROMO_FACT.FORECAST_AP_GROSS_MARGIN_STANDARD,
BUDGET_PROMO_FACT.FORECAST_AP_GCAT_STANDARD,
BUDGET_PROMO_FACT.FORECAST_RETAIL_TOT_VOL_KG,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_MRRSP,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_RSP,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_NET,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_COST_OF_SALES,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_RETAILER_RETRO_FUNDING,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_PROMO_FIXED_SPEND,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_TOTAL_SPEND,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
BUDGET_PROMO_FACT.FORECAST_AP_RETAIL_REVENUE_NET_EXCL_RSP,
BUDGET_PROMO_FACT.ACTUALS_TOT_VOL_CA,
BUDGET_PROMO_FACT.ACTUALS_TOT_VOL_UL,
BUDGET_PROMO_FACT.BASE_TOT_VOL_CA,
BUDGET_PROMO_FACT.BASE_TOT_VOL_UL,
BUDGET_PROMO_FACT.FORECAST_TOT_VOL_CA,
BUDGET_PROMO_FACT.FORECAST_TOT_VOL_UL,
BUDGET_PROMO_FACT.ACTUALS_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS AS PRM_ACTUALS_TOT_VOL_CU,
BUDGET_PROMO_FACT.BASE_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS AS PRM_BASE_TOT_VOL_CU,
BUDGET_PROMO_FACT.FORECAST_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS AS PRM_FORECAST_TOT_VOL_CU,
BUDGET_PROMO_FACT.SI_B_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_B_VOL_CU,
BUDGET_PROMO_FACT.SI_A_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_A_VOL_CU,
BUDGET_PROMO_FACT.SI_T_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_T_VOL_CU,
BUDGET_PROMO_FACT.SI_M_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_M_VOL_CU,
BUDGET_PROMO_FACT.SI_I_VOL_CSE * ITM_EXT.CONSUMER_UNITS AS PRM_SI_I_VOL_CU,
BUDGET_PROMO_FACT.ACTUALS_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_ACTUALS_TOT_VOL_PK,
BUDGET_PROMO_FACT.BASE_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_BASE_TOT_VOL_PK,
BUDGET_PROMO_FACT.FORECAST_TOT_VOL_CA * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_FORECAST_TOT_VOL_PK,
BUDGET_PROMO_FACT.SI_B_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_B_VOL_PK,
BUDGET_PROMO_FACT.SI_A_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_A_VOL_PK,
BUDGET_PROMO_FACT.SI_T_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_T_VOL_PK,
BUDGET_PROMO_FACT.SI_M_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_M_VOL_PK,
BUDGET_PROMO_FACT.SI_I_VOL_CSE * ITM_EXT.CONSUMER_UNITS_IN_TRADE_UNITS AS PRM_SI_I_VOL_PK,
PROMO_DIM.PROMO_ID,
PROMO_DIM.PROMO_CODE,
PROMO_DIM.PROMO_DESC,
PROMO_DIM.PROMO_TACTIC_DESC,
PROMO_DIM.PROMO_SUB_TACTIC_DESC,
PROMO_DIM.PROMO_SUB_TACTIC_DISCOUNT,
PROMO_DIM.PROMO_SUB_TACTIC_ISACTIVE,
PROMO_DIM.PROMO_STAT_DESC,
PROMO_DIM.PROMO_PHASE_DESC,
PROMO_DIM.PROMO_PHASE_LENGTH,
PROMO_DIM.PROMO_PHASE_EFFECT_DESC,
PROMO_DIM.PROMO_PHASE_TYPE_DESC,
PROMO_DIM.PROMO_PHASE_TYPE_UNIT,
PROMO_DIM.AUTHORIZED_USER_NAME,
PROMO_DIM.BUY_IN_START_DT,
PROMO_DIM.BUY_IN_END_DT,
PROMO_DIM.IN_STORE_START_DT,
PROMO_DIM.IN_STORE_END_DT,
PROMO_DIM.PERFORMANCE_START_DT,
PROMO_DIM.PERFORMANCE_END_DT,
PROMO_DIM.FEATURE,
PROMO_DIM.FEATURE_DESC,
PROMO_DIM.PROMO_MECHANIC_NAME,
PLAN.MARKET AS MARKET,
PLAN.SUB_MARKET AS SUBMARKET,
PLAN.TRADE_CLASS AS TRADE_CLASS,
PLAN.TRADE_GROUP AS TRADE_GROUP,
PLAN.TRADE_TYPE AS TRADE_TYPE,
PLAN.TRADE_SECTOR_DESC AS TRADE_SECTOR,
ITM_EXT.DESCRIPTION,
ITM_EXT.ITEM_TYPE, 
ITM_EXT.BRANDING_DESC, 
ITM_EXT.PRODUCT_CLASS_DESC, 
ITM_EXT.SUB_PRODUCT_DESC, 
ITM_EXT.STRATEGIC_DESC, 
ITM_EXT.POWER_BRAND_DESC, 
ITM_EXT.MANUFACTURING_GROUP_DESC, 
ITM_EXT.CATEGORY_DESC, 
ITM_EXT.PACK_SIZE_DESC, 
ITM_EXT.SUB_CATEGORY_DESC,
ITM_EXT.PROMO_TYPE_DESC,
DT.REPORT_FISCAL_YEAR,
DT.REPORT_FISCAL_YEAR_PERIOD_NO,
DT.FISCAL_YEAR_BEGIN_DT,
DT.FISCAL_YEAR_END_DT,
DTP.PLANNING_WEEK_CODE,
DTP.PLANNING_WEEK_START_DT,
DTP.PLANNING_WEEK_END_DT,
DTP.PLANNING_WEEK_NO,
DTP.PLANNING_MONTH_CODE,
DTP.PLANNING_MONTH_START_DT,
DTP.PLANNING_MONTH_END_DT,
DTP.PLANNING_QUARTER_NO,
DTP.PLANNING_QUARTER_START_DT,
DTP.PLANNING_QUARTER_END_DT,
DTP.PLANNING_YEAR_NO,
DTP.PLANNING_YEAR_START_DT,
DTP.PLANNING_YEAR_END_DT,
CUST.BILL_NAME
FROM cte_budget_promo BUDGET_PROMO_FACT
LEFT JOIN cte_dim_date DT
    ON BUDGET_PROMO_FACT.CALENDAR_DATE = DT.CALENDAR_DATE
LEFT JOIN cte_planning_Date_oc DTP
    ON BUDGET_PROMO_FACT.SOURCE_SYSTEM = DTP.SOURCE_SYSTEM
    AND BUDGET_PROMO_FACT.CALENDAR_DATE = DTP.CALENDAR_DATE
LEFT JOIN (SELECT SOURCE_SYSTEM, ITEM_GUID, MAX(ITEM_TYPE) AS ITEM_TYPE, MAX(BRANDING_DESC) AS BRANDING_DESC, MAX(PRODUCT_CLASS_DESC) AS PRODUCT_CLASS_DESC, MAX(SUB_PRODUCT_DESC) AS SUB_PRODUCT_DESC
            , MAX(STRATEGIC_DESC) AS STRATEGIC_DESC, MAX(POWER_BRAND_DESC) AS POWER_BRAND_DESC, MAX(MANUFACTURING_GROUP_DESC) AS MANUFACTURING_GROUP_DESC
            , MAX(CATEGORY_DESC) AS CATEGORY_DESC, MAX(PACK_SIZE_DESC) AS PACK_SIZE_DESC, MAX(SUB_CATEGORY_DESC) AS SUB_CATEGORY_DESC
            , MAX(CONSUMER_UNITS_IN_TRADE_UNITS) AS CONSUMER_UNITS_IN_TRADE_UNITS, MAX(PROMO_TYPE_DESC) AS PROMO_TYPE_DESC, MAX(CONSUMER_UNITS) AS CONSUMER_UNITS,
            MAX(DESCRIPTION) AS DESCRIPTION
            FROM cte_item_ext 
            GROUP BY SOURCE_SYSTEM, ITEM_GUID) ITM_EXT
    ON BUDGET_PROMO_FACT.SOURCE_SYSTEM = ITM_EXT.SOURCE_SYSTEM
    AND BUDGET_PROMO_FACT.ITEM_GUID = ITM_EXT.ITEM_GUID
LEFT JOIN cte_v_wtx_cust_planning PLAN
    ON TRIM(BUDGET_PROMO_FACT.PLAN_SOURCE_CUSTOMER_CODE) = TRIM(PLAN.TRADE_TYPE_CODE)
LEFT JOIN cte_promo_dim_hist PROMO_DIM --EI_RDM.SLS_WTX_PROMO_DIM_HIST  
    ON BUDGET_PROMO_FACT.PROMO_GUID = PROMO_DIM.PROMO_GUID
	AND BUDGET_PROMO_FACT.SNAPSHOT_DATE = PROMO_DIM.SNAPSHOT_DATE
LEFT JOIN (select distinct SOURCE_SYSTEM,CUSTOMER_ADDRESS_NUMBER_GUID,COMPANY_CODE,BILL_NAME from
cte_customer 
where BILL_NAME is not null and COMPANY_CODE='WBX') CUST
ON BUDGET_PROMO_FACT.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
 AND BUDGET_PROMO_FACT.PRM_RPT_CUSTOMER_GUID = CUST.CUSTOMER_ADDRESS_NUMBER_GUID
INNER JOIN (SELECT * FROM cte_sls_wtx_budget_scen_xref WHERE CURRENT_VERSION_FLAG=1) SCEN
    ON BUDGET_PROMO_FACT.FROZEN_FORECAST=SCEN.FROZEN_FORECAST
)
select 
    SOURCE_SYSTEM,
	SOURCE_ITEM_IDENTIFIER,
	PLAN_SOURCE_CUSTOMER_CODE,
	CALENDAR_DATE,
	SNAPSHOT_DATE,
	FROZEN_FORECAST,
	FROZEN_FORECAST_DELINEATION_DATE,
	SOURCE_CONTENT_FILTER,
	ISPROMOSKU,
	ISCANNIBSKU,
	SI_B_VOL_CSE,
	SI_A_VOL_CSE,
	SI_T_VOL_CSE,
	SI_M_VOL_CSE,
	SI_I_VOL_CSE,
	SI_B_VOL_KG,
	SI_A_VOL_KG,
	SI_T_VOL_KG,
	SI_M_VOL_KG,
	ACTUALS_TOT_VOL_KG,
	BASE_TOT_VOL_KG,
	FORECAST_TOT_VOL_KG,
	SI_I_VOL_KG,
	ACTUALS_AP_GROSS_SALES_VALUE,
	ACTUALS_AP_RANGE_SUPPORT_ALLOWANCE,
	ACTUALS_AP_EVERYDAY_LOW_PRICES,
	ACTUALS_AP_PERMANENT_DISC,
	ACTUALS_AP_OFF_INVOICE_DISC,
	ACTUALS_AP_INVOICED_SALES_VALUE,
	ACTUALS_AP_EARLY_SETTLEMENT_DISC,
	ACTUALS_AP_GROWTH_INCENTIVES,
	ACTUALS_AP_NET_SALES_VALUE,
	ACTUALS_AP_RETRO,
	ACTUALS_AP_AVP_DISC,
	ACTUALS_AP_VARIABLE_TRADE,
	ACTUALS_AP_PROMO_FIXED_FUNDING,
	ACTUALS_AP_RANGE_SUPPORT_INCENTIVES,
	ACTUALS_AP_NET_NET_SALES_VALUE,
	ACTUALS_AP_DIRECT_SHOPPER_MARKETING,
	ACTUALS_AP_OTHER_DIRECT_PAYMENTS,
	ACTUALS_AP_INDIRECT_SHOPPER_MARKETING,
	ACTUALS_AP_OTHER_INDIRECT_PAYMENTS,
	ACTUALS_AP_FIXED_TRADE_CUST_INVOICED,
	ACTUALS_AP_TOTAL_TRADE_CUST_INVOICED,
	ACTUALS_AP_FIXED_TRADE_NON_CUST_INVOICED,
	ACTUALS_AP_TOTAL_TRADE,
	ACTUALS_AP_NET_REALISABLE_REVENUE,
	ACTUALS_AP_TOT_PRIME_COST_STANDARD,
	ACTUALS_AP_GROSS_MARGIN_STANDARD,
	ACTUALS_AP_GCAT_STANDARD,
	ACTUALS_RETAIL_TOT_VOL_KG,
	ACTUALS_AP_RETAIL_REVENUE_MRRSP,
	ACTUALS_AP_RETAIL_REVENUE_RSP,
	ACTUALS_AP_RETAIL_REVENUE_NET,
	ACTUALS_AP_RETAIL_COST_OF_SALES,
	ACTUALS_AP_RETAIL_RETAILER_RETRO_FUNDING,
	ACTUALS_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
	ACTUALS_AP_RETAIL_PROMO_FIXED_SPEND,
	ACTUALS_AP_RETAIL_TOTAL_SPEND,
	ACTUALS_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
	ACTUALS_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
	ACTUALS_AP_RETAIL_REVENUE_NET_EXCL_RSP,
	BASE_AP_GROSS_SALES_VALUE,
	BASE_AP_RANGE_SUPPORT_ALLOWANCE,
	BASE_AP_EVERYDAY_LOW_PRICES,
	BASE_AP_PERMANENT_DISC,
	BASE_AP_OFF_INVOICE_DISC,
	BASE_AP_INVOICED_SALES_VALUE,
	BASE_AP_EARLY_SETTLEMENT_DISC,
	BASE_AP_GROWTH_INCENTIVES,
	BASE_AP_NET_SALES_VALUE,
	BASE_AP_RETRO,
	BASE_AP_AVP_DISC,
	BASE_AP_VARIABLE_TRADE,
	BASE_AP_PROMO_FIXED_FUNDING,
	BASE_AP_RANGE_SUPPORT_INCENTIVES,
	BASE_AP_NET_NET_SALES_VALUE,
	BASE_AP_DIRECT_SHOPPER_MARKETING,
	BASE_AP_OTHER_DIRECT_PAYMENTS,
	BASE_AP_INDIRECT_SHOPPER_MARKETING,
	BASE_AP_OTHER_INDIRECT_PAYMENTS,
	BASE_AP_FIXED_TRADE_CUST_INVOICED,
	BASE_AP_TOTAL_TRADE_CUST_INVOICED,
	BASE_AP_FIXED_TRADE_NON_CUST_INVOICED,
	BASE_AP_TOTAL_TRADE,
	BASE_AP_NET_REALISABLE_REVENUE,
	BASE_AP_TOT_PRIME_COST_STANDARD,
	BASE_AP_GROSS_MARGIN_STANDARD,
	BASE_AP_GCAT_STANDARD,
	BASE_RETAIL_TOT_VOL_KG,
	BASE_AP_RETAIL_REVENUE_MRRSP,
	BASE_AP_RETAIL_REVENUE_RSP,
	BASE_AP_RETAIL_REVENUE_NET,
	BASE_AP_RETAIL_COST_OF_SALES,
	BASE_AP_RETAIL_RETAILER_RETRO_FUNDING,
	BASE_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
	BASE_AP_RETAIL_PROMO_FIXED_SPEND,
	BASE_AP_RETAIL_TOTAL_SPEND,
	BASE_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
	BASE_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
	BASE_AP_RETAIL_REVENUE_NET_EXCL_RSP,
	FORECAST_AP_GROSS_SALES_VALUE,
	FORECAST_AP_RANGE_SUPPORT_ALLOWANCE,
	FORECAST_AP_EVERYDAY_LOW_PRICES,
	FORECAST_AP_PERMANENT_DISC,
	FORECAST_AP_OFF_INVOICE_DISC,
	FORECAST_AP_INVOICED_SALES_VALUE,
	FORECAST_AP_EARLY_SETTLEMENT_DISC,
	FORECAST_AP_GROWTH_INCENTIVES,
	FORECAST_AP_NET_SALES_VALUE,
	FORECAST_AP_RETRO,
	FORECAST_AP_AVP_DISC,
	FORECAST_AP_VARIABLE_TRADE,
	FORECAST_AP_PROMO_FIXED_FUNDING,
	FORECAST_AP_RANGE_SUPPORT_INCENTIVES,
	FORECAST_AP_NET_NET_SALES_VALUE,
	FORECAST_AP_DIRECT_SHOPPER_MARKETING,
	FORECAST_AP_OTHER_DIRECT_PAYMENTS,
	FORECAST_AP_INDIRECT_SHOPPER_MARKETING,
	FORECAST_AP_OTHER_INDIRECT_PAYMENTS,
	FORECAST_AP_FIXED_TRADE_CUST_INVOICED,
	FORECAST_AP_TOTAL_TRADE_CUST_INVOICED,
	FORECAST_AP_FIXED_TRADE_NON_CUST_INVOICED,
	FORECAST_AP_TOTAL_TRADE,
	FORECAST_AP_TOTAL_TRADE_GBP,
	FORECAST_AP_NET_REALISABLE_REVENUE,
	FORECAST_AP_TOT_PRIME_COST_STANDARD,
	FORECAST_AP_GROSS_MARGIN_STANDARD,
	FORECAST_AP_GCAT_STANDARD,
	FORECAST_RETAIL_TOT_VOL_KG,
	FORECAST_AP_RETAIL_REVENUE_MRRSP,
	FORECAST_AP_RETAIL_REVENUE_RSP,
	FORECAST_AP_RETAIL_REVENUE_NET,
	FORECAST_AP_RETAIL_COST_OF_SALES,
	FORECAST_AP_RETAIL_RETAILER_RETRO_FUNDING,
	FORECAST_AP_RETAIL_MARGIN_EXCL_FIXED_FUNDING,
	FORECAST_AP_RETAIL_PROMO_FIXED_SPEND,
	FORECAST_AP_RETAIL_TOTAL_SPEND,
	FORECAST_AP_RETAIL_MARGIN_INCL_FIXED_FUNDING,
	FORECAST_AP_RETAIL_REVENUE_NET_EXCL_MRRSP,
	FORECAST_AP_RETAIL_REVENUE_NET_EXCL_RSP,
	ACTUALS_TOT_VOL_CA,
	ACTUALS_TOT_VOL_UL,
	BASE_TOT_VOL_CA,
	BASE_TOT_VOL_UL,
	FORECAST_TOT_VOL_CA,
	FORECAST_TOT_VOL_UL,
	PRM_ACTUALS_TOT_VOL_CU,
	PRM_BASE_TOT_VOL_CU,
	PRM_FORECAST_TOT_VOL_CU,
	PRM_SI_B_VOL_CU,
	PRM_SI_A_VOL_CU,
	PRM_SI_T_VOL_CU,
	PRM_SI_M_VOL_CU,
	PRM_SI_I_VOL_CU,
	PRM_ACTUALS_TOT_VOL_PK,
	PRM_BASE_TOT_VOL_PK,
	PRM_FORECAST_TOT_VOL_PK,
	PRM_SI_B_VOL_PK,
	PRM_SI_A_VOL_PK,
	PRM_SI_T_VOL_PK,
	PRM_SI_M_VOL_PK,
	PRM_SI_I_VOL_PK,
	PROMO_ID,
	PROMO_CODE,
	PROMO_DESC,
	PROMO_TACTIC_DESC,
	PROMO_SUB_TACTIC_DESC,
	PROMO_SUB_TACTIC_DISCOUNT,
	PROMO_SUB_TACTIC_ISACTIVE,
	PROMO_STAT_DESC,
	PROMO_PHASE_DESC,
	PROMO_PHASE_LENGTH,
	PROMO_PHASE_EFFECT_DESC,
	PROMO_PHASE_TYPE_DESC,
	PROMO_PHASE_TYPE_UNIT,
	AUTHORIZED_USER_NAME,
	BUY_IN_START_DT,
	BUY_IN_END_DT,
	IN_STORE_START_DT,
	IN_STORE_END_DT,
	PERFORMANCE_START_DT,
	PERFORMANCE_END_DT,
	FEATURE,
	FEATURE_DESC,
	PROMO_MECHANIC_NAME,
	MARKET,
	SUBMARKET,
	TRADE_CLASS,
	TRADE_GROUP,
	TRADE_TYPE,
	TRADE_SECTOR,
	DESCRIPTION,
	ITEM_TYPE,
	BRANDING_DESC,
	PRODUCT_CLASS_DESC,
	SUB_PRODUCT_DESC,
	STRATEGIC_DESC,
	POWER_BRAND_DESC,
	MANUFACTURING_GROUP_DESC,
	CATEGORY_DESC,
	PACK_SIZE_DESC,
	SUB_CATEGORY_DESC,
	PROMO_TYPE_DESC,
	REPORT_FISCAL_YEAR,
	REPORT_FISCAL_YEAR_PERIOD_NO,
	FISCAL_YEAR_BEGIN_DT,
	FISCAL_YEAR_END_DT,
	PLANNING_WEEK_CODE,
	PLANNING_WEEK_START_DT,
	PLANNING_WEEK_END_DT,
	PLANNING_WEEK_NO,
	PLANNING_MONTH_CODE,
	PLANNING_MONTH_START_DT,
	PLANNING_MONTH_END_DT,
	PLANNING_QUARTER_NO,
	PLANNING_QUARTER_START_DT,
	PLANNING_QUARTER_END_DT,
	PLANNING_YEAR_NO,
	PLANNING_YEAR_START_DT,
	PLANNING_YEAR_END_DT,
	BILL_NAME
from cte_final
