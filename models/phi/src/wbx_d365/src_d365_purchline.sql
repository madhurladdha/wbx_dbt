with d365_source as (

        select *
        from {{ source("D365", "purch_line") }} where  _FIVETRAN_DELETED='FALSE' AND upper(trim(data_area_id)) in {{env_var("DBT_D365_COMPANY_FILTER")}}
    ),

    renamed as (


        select
            'D365' as source,
            purch_id as purchid,
            item_id as itemid,
            purch_status as purchstatus,
            shipping_date_requested as shippingdaterequested,
            delivery_date as deliverydate,
            name as name,
            tax_group as taxgroup,
            qty_ordered as qtyordered,
            purch_received_now as purchreceivednow,
            remain_purch_physical as remainpurchphysical,
            remain_purch_financial as remainpurchfinancial,
            price_unit as priceunit,
            purch_price as purchprice,
            currency_code as currencycode,
            line_percent as linepercent,
            line_disc as linedisc,
            line_amount as lineamount,
            external_item_id as externalitemid,
            purch_unit as purchunit,
            confirmed_dlv as confirmeddlv,             
            address_ref_rec_id as addressrefrecid,
            invent_trans_id as inventtransid,
            vend_group as vendgroup,
            vend_account as vendaccount,
            address_ref_table_id as addressreftableid,
            purch_qty as purchqty,
            purch_markup as purchmarkup,
            invent_received_now as inventreceivednow,
            multi_ln_disc as multilndisc,
            multi_ln_percent as multilnpercent,
            purchase_type as purchasetype,
            cov_ref as covref,
            remain_invent_physical as remaininventphysical,
            tax_item_group as taxitemgroup,
            null as transactioncode,
            shipping_date_confirmed as shippingdateconfirmed,
            null as countyorigdest,
            tax_autogenerated as taxautogenerated,
            under_delivery_pct as underdeliverypct,
            over_delivery_pct as overdeliverypct,
            tax_1099_amount as tax1099amount,
            bar_code as barcode,
            bar_code_type as barcodetype,
            invent_ref_id as inventrefid,
            invent_ref_trans_id as inventreftransid,
            item_ref_type as itemreftype,
            null as projtransid,
            blocked as blocked,
            complete as complete,
            req_plan_id_sched as reqplanidsched,
            req_poid as reqpoid,
            null as itemrouteid,
            null as itembomid,
            null as lineheader,
            scrap as scrap,
            return_action_id as returnactionid,
            inter_company_origin as intercompanyorigin,
            proj_category_id as projcategoryid, --added this during fact testing of FCT_WBX_FIN_PRC_PO
            null as projid,
            invent_dim_id as inventdimid,
            null as transport,
            null as statprocid,
            null as port,
            null as assetid,
            asset_trans_type_purch as assettranstypepurch,
            null as assetbookid,
            null as projlinepropertyid,
            null as projtaxitemgroupid,
            null as projtaxgroupid,
            proj_sales_price as projsalesprice,
            null as projsalescurrencyid,
            inter_company_invent_trans_id as intercompanyinventtransid,
            null as projsalesunitid,
            delivery_name as deliveryname,
            delivery_type as deliverytype,
            customer_ref as customerref,
            null as custpurchaseorderformnum,
            stat_triangular_deal as stattriangulardeal,
            null as tax1099state,
            tax_1099_state_amount as tax1099stateamount,
            null as itemtagging,
            null as casetagging,
            null as pallettagging,
            remain_invent_financial as remaininventfinancial,
            purch_req_line_ref_id as purchreqlinerefid,
            depreciation_start_date as depreciationstartdate,
            null as activitynumber,
            return_status as returnstatus,
            null as returndispositioncodeid,
            create_fixed_asset as createfixedasset,
            null as assetgroup,
            null as reqattention,
            null as purchreqid,
            tax_1099_rec_id as tax1099recid,
            matching_policy as matchingpolicy,             
            procurement_category as procurementcategory,
            line_delivery_type as linedeliverytype,             
            source_document_line as sourcedocumentline,             
            default_dimension as defaultdimension,
            ledger_dimension as ledgerdimension,
            is_deleted as isdeleted,
            is_modified as ismodified,             
            matching_agreement_line as matchingagreementline,             
            manual_entry_changepolicy as manualentrychangepolicy,             
            system_entry_change_policy as systementrychangepolicy,
            system_entry_source as systementrysource,
            workflow_state as workflowstate,
            editable_in_workflow as editableinworkflow,
            wf_inv_received_state as wfinvreceivedstate,
            wf_delivery_due_state as wfdeliveryduestate,
            tax_1099_fields as tax1099fields,
            gsthsttax_type_ca as gsthsttaxtype_ca,             
            delivery_postal_address as deliverypostaladdress,
            line_number as linenumber,
            tax_withhold_item_group_heading_th as taxwithholditemgroupheading_th,             
            requester as requester,
            accounting_distribution_template as accountingdistributiontemplate,
            operation_type_mx as operationtype_mx,
            stocked_product as stockedproduct,
            is_finalized as isfinalized,
            plan_reference as planreference,
            is_invoice_matched as isinvoicematched,
            null as itempbaid,
            tax_withhold_base_cur_th as taxwithholdbasecur_th,
            null as taxwithholdgroup_th,
            null as taxservicecode_br,
            intrastat_fulfillment_date_hu as intrastatfulfillmentdate_hu,
            cfoptable_br as cfoptable_br,
            statistic_value_lt as statisticvalue_lt,
            null as psaretainscheduleid,
            psatotal_retain_amount as psatotalretainamount,
            service_date as servicedate,
            remainder as remainder,
            null as serviceaddress,
            invent_invoice_now as inventinvoicenow,
            retail_line_num_ex_1 as retaillinenumex1,
            variant_id as variantid,
            null as retailpackageid,
            rbopackage_line_num as rbopackagelinenum,
            retail_temp_value_ex_2 as retailtempvalueex2,
            mcrdrop_shipment as mcrdropshipment,
            null as mcrdropshipcomment,
            mcrdrop_ship_status as mcrdropshipstatus,
            agreement_skip_auto_link as agreementskipautolink,
            confirmed_tax_amount as confirmedtaxamount,
            null as confirmedtaxwritecode,
            disc_amount as discamount,
            disc_percent as discpercent,
            is_pwp as ispwp,
            manual_modified_field as manualmodifiedfield,             
            mcrorder_line_2_price_history_ref as mcrorderline2pricehistoryref,
            null as pdscalculationid,
            pds_cwinvent_received_now as pdscwinventreceivednow,
            pds_cwqty as pdscwqty,
            pds_cwremain_invent_financial as pdscwremaininventfinancial,
            pds_cwremain_invent_physical as pdscwremaininventphysical,
            proj_worker as projworker,
            purch_commitment_line_psn as purchcommitmentline_psn,
            skipdistributionupdate as skipdistributionupdate,
            null as tamitemvendrebategroupid,
            modifieddatetime as modifieddatetime,
            createddatetime as createddatetime,
            upper(data_area_id) as dataareaid,
            recversion as recversion,
            partition as partition,
            recid as recid,            
            budget_reservation_line_psn as budgetreservationline_psn,             
            credited_vend_invoice_trans as creditedvendinvoicetrans
        from d365_source
    )

select *
from renamed qualify row_number() over(partition by purchid,dataareaid,inventtransid order by source desc)=1
