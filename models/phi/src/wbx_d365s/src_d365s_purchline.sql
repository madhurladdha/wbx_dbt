with d365source as (

        select *
        from {{ source("D365S", "purchline") }} where  _FIVETRAN_DELETED='FALSE' AND upper(trim(dataareaid)) in {{env_var("DBT_D365_COMPANY_FILTER")}}
    ),

    renamed as (


        select
            'D365' as source,
            purchid as purchid,
            itemid as itemid,
            purchstatus as purchstatus,
            cast(shippingdaterequested as TIMESTAMP_NTZ) as shippingdaterequested,
            cast(deliverydate as TIMESTAMP_NTZ) as deliverydate,
            name as name,
            taxgroup as taxgroup,
            qtyordered as qtyordered,
            purchreceivednow as purchreceivednow,
            remainpurchphysical as remainpurchphysical,
            remainpurchfinancial as remainpurchfinancial,
            priceunit as priceunit,
            purchprice as purchprice,
            currencycode as currencycode,
            linepercent as linepercent,
            linedisc as linedisc,
            lineamount as lineamount,
            externalitemid as externalitemid,
            purchunit as purchunit,
            cast(confirmeddlv as TIMESTAMP_NTZ) as confirmeddlv,             
            addressrefrecid as addressrefrecid,
            inventtransid as inventtransid,
            vendgroup as vendgroup,
            vendaccount as vendaccount,
            addressreftableid as addressreftableid,
            purchqty as purchqty,
            purchmarkup as purchmarkup,
            inventreceivednow as inventreceivednow,
            multilndisc as multilndisc,
            multilnpercent as multilnpercent,
            purchasetype as purchasetype,
            covref as covref,
            remaininventphysical as remaininventphysical,
            taxitemgroup as taxitemgroup,
            null as transactioncode,
            cast(shippingdateconfirmed as TIMESTAMP_NTZ) as shippingdateconfirmed,
            null as countyorigdest,
            taxautogenerated as taxautogenerated,
            underdeliverypct as underdeliverypct,
            overdeliverypct as overdeliverypct,
            tax_1099_amount as tax1099amount,
            barcode as barcode,
            barcodetype as barcodetype,
            inventrefid as inventrefid,
            inventreftransid as inventreftransid,
            itemreftype as itemreftype,
            null as projtransid,
            blocked as blocked,
            complete as complete,
            reqplanidsched as reqplanidsched,
            reqpoid as reqpoid,
            null as itemrouteid,
            null as itembomid,
            null as lineheader,
            scrap as scrap,
            returnactionid as returnactionid,
            intercompanyorigin as intercompanyorigin,
            projcategoryid as projcategoryid, --added this during fact testing of FCT_WBX_FIN_PRC_PO
            null as projid,
            inventdimid as inventdimid,
            null as transport,
            null as statprocid,
            null as port,
            null as assetid,
            assettranstypepurch as assettranstypepurch,
            null as assetbookid,
            null as projlinepropertyid,
            null as projtaxitemgroupid,
            null as projtaxgroupid,
            projsalesprice as projsalesprice,
            null as projsalescurrencyid,
            intercompanyinventtransid as intercompanyinventtransid,
            null as projsalesunitid,
            deliveryname as deliveryname,
            deliverytype as deliverytype,
            customerref as customerref,
            null as custpurchaseorderformnum,
            stattriangulardeal as stattriangulardeal,
            null as tax1099state,
            tax_1099_stateamount as tax1099stateamount,
            null as itemtagging,
            null as casetagging,
            null as pallettagging,
            remaininventfinancial as remaininventfinancial,
            purchreqlinerefid as purchreqlinerefid,
            cast(depreciationstartdate as TIMESTAMP_NTZ) as depreciationstartdate,
            null as activitynumber,
            returnstatus as returnstatus,
            null as returndispositioncodeid,
            createfixedasset as createfixedasset,
            null as assetgroup,
            null as reqattention,
            null as purchreqid,
            tax_1099_recid as tax1099recid,
            matchingpolicy as matchingpolicy,             
            procurementcategory as procurementcategory,
            linedeliverytype as linedeliverytype,             
            sourcedocumentline as sourcedocumentline,             
            defaultdimension as defaultdimension,
            ledgerdimension as ledgerdimension,
            isdeleted as isdeleted,
            ismodified as ismodified,             
            matchingagreementline as matchingagreementline,             
            manualentrychangepolicy as manualentrychangepolicy,             
            systementrychangepolicy as systementrychangepolicy,
            systementrysource as systementrysource,
            workflowstate as workflowstate,
            editableinworkflow as editableinworkflow,
            wfinvreceivedstate as wfinvreceivedstate,
            wfdeliveryduestate as wfdeliveryduestate,
            tax_1099_fields as tax1099fields,
            gsthsttaxtype_ca as gsthsttaxtype_ca,             
            deliverypostaladdress as deliverypostaladdress,
            linenumber as linenumber,
            taxwithholditemgroupheading_th as taxwithholditemgroupheading_th,             
            requester as requester,
            accountingdistributiontemplate as accountingdistributiontemplate,
            operationtype_mx as operationtype_mx,
            stockedproduct as stockedproduct,
            isfinalized as isfinalized,
            planreference as planreference,
            isinvoicematched as isinvoicematched,
            null as itempbaid,
            taxwithholdbasecur_th as taxwithholdbasecur_th,
            null as taxwithholdgroup_th,
            null as taxservicecode_br,
            cast(intrastatfulfillmentdate_hu as TIMESTAMP_NTZ) as intrastatfulfillmentdate_hu,
            cfoptable_br as cfoptable_br,
            statisticvalue_lt as statisticvalue_lt,
            null as psaretainscheduleid,
            psatotalretainamount as psatotalretainamount,
            cast(servicedate as TIMESTAMP_NTZ) as servicedate,
            remainder as remainder,
            null as serviceaddress,
            inventinvoicenow as inventinvoicenow,
            retaillinenumex_1 as retaillinenumex1,
            variantid as variantid,
            null as retailpackageid,
            rbopackagelinenum as rbopackagelinenum,
            retailtempvalueex_2 as retailtempvalueex2,
            mcrdropshipment as mcrdropshipment,
            null as mcrdropshipcomment,
            mcrdropshipstatus as mcrdropshipstatus,
            agreementskipautolink as agreementskipautolink,
            confirmedtaxamount as confirmedtaxamount,
            null as confirmedtaxwritecode,
            discamount as discamount,
            discpercent as discpercent,
            ispwp as ispwp,
            manualmodifiedfield as manualmodifiedfield,             
            mcrorderline_2_pricehistoryref as mcrorderline2pricehistoryref,
            null as pdscalculationid,
            pdscwinventreceivednow as pdscwinventreceivednow,
            pdscwqty as pdscwqty,
            pdscwremaininventfinancial as pdscwremaininventfinancial,
            pdscwremaininventphysical as pdscwremaininventphysical,
            projworker as projworker,
            purchcommitmentline_psn as purchcommitmentline_psn,
            skipdistributionupdate as skipdistributionupdate,
            null as tamitemvendrebategroupid,
            cast(modifieddatetime as TIMESTAMP_NTZ) as modifieddatetime,
            cast(createddatetime as TIMESTAMP_NTZ) as createddatetime,
            upper(dataareaid) as dataareaid,
            recversion as recversion,
            partition as partition,
            recid as recid,            
            budgetreservationline_psn as budgetreservationline_psn,             
            creditedvendinvoicetrans as creditedvendinvoicetrans
        from d365source
    )

select *
from renamed qualify row_number() over(partition by purchid,dataareaid,inventtransid order by source desc)=1
